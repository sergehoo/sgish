{% extends 'layout/base.html' %}
{% load static %}
{% load humanize %}
{% block content %}
    <style>
        .uniform-btn {
            width: 100%;
            min-width: 100px; /* Définit une largeur minimale pour tous les boutons */
            text-align: left; /* Centre le texte dans les boutons */
            padding: 5px 5px; /* Uniformise le padding des boutons */
            font-size: 16px; /* Assure une taille de texte uniforme */
        }

        .patient-name h3 {
            word-wrap: break-word;
            white-space: normal;
            overflow-wrap: break-word;
            max-width: 100%; /* Empêche le débordement */
        }

        .custom-checkbox {
    width: 20px; /* Largeur du checkbox */
    height: 20px; /* Hauteur du checkbox */
    cursor: pointer; /* Curseur cliquable */
    transform: scale(1.5); /* Agrandit le checkbox */
    margin-right: 40px; /* Espacement avec le texte */
}
    </style>
    <div class="nk-content nk-content-fluid">

        <div class="container-xl wide-lg">

            <div class="nk-content-body">

                <div class="nk-block-head nk-block-head-sm ">
                
                <div class="row rounded card-bordered mt-5 p-3 d-flex align-items-center" style="background-color: white; background-image: url('{% static 'images/hospitalizadtion.png' %}'); background-size: cover; background-position: center;">
    
    <!-- Colonne : Informations du patient -->
    <div class="col-lg-6 col-md-6 col-sm-6 d-flex flex-column justify-content-center">
        <h3 class="nk-block-title page-title text-lg-right text-center text-dark">Détails Hospitalisation Patient</h3>
        <a href="{% url 'detail_patient' hospitalisationdetail.patient.pk %}" class="patient-name">
            <h3 class="text-primary">{{ hospitalisationdetail.patient|upper }}</h3>
        </a>
        <h6>
            Code Patient: <span class="text-danger">{{ hospitalisationdetail.patient.code_patient }}</span>
            <br>
            <a href="{% url 'detail_patient' hospitalisationdetail.patient.pk %}" class="text-primary mt-2">
                <em class="icon ni ni-folder-list"></em> Dossier Médical
            </a>
        </h6>

        {% if hospitalisationdetail.discharge_date %}
            <span class="h4 text-success" data-toggle="tooltip" title="{{ hospitalisationdetail.discharge_date }}">
                Patient sorti {{ hospitalisationdetail.discharge_date|naturaltime }}
            </span>
        {% else %}
            <a href="#" data-toggle="modal" data-target="#hospitalisationout" class="btn btn-outline-warning">
                <i class="fa-solid fa-sign-out"></i> Sortir ?
            </a>
        {% endif %}
    </div>

    <!-- Colonne : QR Code Patient -->
    <div class="col-lg-2 col-md-3 col-sm-6 d-flex justify-content-center">
        <img class="img-fluid" src="{{ hospitalisationdetail.patient.qr_code.url }}" height="140" alt="QR Code Patient">
    </div>

    <!-- Colonne : Informations hospitalisation -->
    <div class="col-lg-2 col-md-6 col-sm-6">
        <blockquote class="blockquote text-start">
            <p class="mb-0">Admis le :</p>
            <strong class="text-primary">{{ hospitalisationdetail.created_at }}</strong>
            <footer class="blockquote-footer">{{ hospitalisationdetail.reason_for_admission }}</footer>

            {% if hospitalisationdetail.discharge_date %}
                <p class="mb-0 mt-3">Sortie le :</p>
                <strong class="text-primary">{{ hospitalisationdetail.discharge_date }}</strong>
                <footer class="blockquote-footer">
                    <span class="badge badge-secondary">{{ hospitalisationdetail.status }}</span><br>
                    {{ hospitalisationdetail.discharge_reason }}
                </footer>
            {% endif %}
        </blockquote>
    </div>

    <!-- Colonne : Image animée -->
    <div class="col-lg-2 col-md-3 col-sm-6 d-flex justify-content-center">
        {% if not hospitalisationdetail.discharge_date %}
            <img src="{% static 'images/hospitalization-2.gif' %}" class="img-fluid" height="140" alt="Hospitalization Image">
        {% endif %}
    </div>
</div>
                   
                    <div class="row pl-4 pb-4">
                        <div class="mt-2 col-md-12 text-end">
                            <ul class="nav m-0 p-0 text-end">

                            {% if observations %}
                                <li class="d-flex justify-content-between align-items-center">
                                <button class="btn btn-outline-primary uniform-btn" data-toggle="modal"
                                        data-target="#observationsModal">
                                    <em class="icon ni ni-eye"></em> Observations<span
                                        class="badge badge-info ml-1">{{ observationscount }}</span>
                                </button>
                                </li>

                            {% endif %}
                            <div class="modal fade" id="observationsModal" tabindex="-1"
                                 aria-labelledby="observationsModalLabel" aria-hidden="true">
                                <div class="modal-dialog modal-lg">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="observationsModalLabel">Observations pour
                                                l'Hospitalisation</h5>
                                            <button type="button" class="btn btn-outline-secondary"
                                                    data-bs-dismiss="modal" aria-label="Close"><em
                                                    class="icon ni ni-close"></em></button>
                                        </div>
                                        <div class="modal-body">
                                            {% if observations %}
                                                <ul class="list-group">
                                                    {% for observation in observations %}
                                                        <li class="list-group-item">
                                                            <div class="d-flex justify-content-between align-items-center">
                                                                <div>
                                                                    <h6 class="mb-1">
                                                                        <strong>{{ observation.date_enregistrement|naturaltime }}</strong>
                                                                        -
                                                                        <span class="badge badge-info text-dark">{{ observation.statut }}</span>
                                                                    </h6>
                                                                    <div class="mb-1">{{ observation.details|safe }}</div>
                                                                    <small class="text-muted">Enregistré par
                                                                        : {{ observation.medecin.get_full_name|default:"Non spécifié" }}</small>
                                                                </div>
                                                                <div>
                                                                    {% if observation.medecin == request.user %}
                                                                        <!-- Button to delete observation -->
                                                                        <form method="post"
                                                                              action=""
                                                                              style="display:inline;">
                                                                            {% csrf_token %}
                                                                            <button type="submit"
                                                                                    class="btn btn-danger btn-sm"
                                                                                    onclick="return confirm('Voulez-vous vraiment supprimer cette observation ?')">
                                                                                Supprimer
                                                                            </button>
                                                                        </form>
                                                                    {% endif %}
                                                                </div>
                                                            </div>
                                                        </li>
                                                    {% endfor %}
                                                </ul>
                                            {% else %}
                                                <div class="alert alert-info text-center">
                                                    Aucune observation enregistrée pour cette hospitalisation.
                                                </div>
                                            {% endif %}
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                                Fermer
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {% if historiques_maladie %}

                                        <li class="d-flex justify-content-between align-items-center">
                                <button class="btn btn-outline-primary ml-2 uniform-btn" data-toggle="modal"
                                        data-target="#historiqueModal">
                                    <em class="icon ni ni-book"></em>Histoire Maladie<span
                                        class="badge badge-info ml-1">{{ effets_indesirablescount }}</span>
                                </button>
                                        </li>

                            {% endif %}
                            <!-- Modal Historique -->
                            <div class="modal fade" id="historiqueModal" tabindex="-1"
                                 aria-labelledby="historiqueModalLabel" aria-hidden="true">
                                <div class="modal-dialog modal-lg">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="historiqueModalLabel">Historique de la
                                                Maladie</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                    aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            {% if historiques_maladie %}
                                                <ul class="list-group">
                                                    {% for historique in historiques_maladie %}
                                                        <li class="list-group-item">
                                                            <div class="d-flex justify-content-between align-items-center">
                                                                <div>
                                                                    <h6 class="mb-1">
                                                                        <strong>{{ historique.date_enregistrement|date:"d/m/Y H:i" }}</strong>
                                                                        -
                                                                        <span class="badge bg-info text-dark">Par {{ historique.medecin.get_full_name|default:"Médecin inconnu" }}</span>
                                                                    </h6>
                                                                    <p class="mb-1">
                                                                        <strong>Details
                                                                            :</strong>
                                                                    </p>
                                                                     {{ historique.description|safe }}


                                                                </div>
                                                                <div>
                                                                    {% if historique.medecin == request.user %}
                                                                        <!-- Button to delete historique -->
                                                                        <form method="post" action=""
                                                                              style="display:inline;">
                                                                            {% csrf_token %}
                                                                            <button type="submit"
                                                                                    class="btn btn-danger btn-sm"
                                                                                    onclick="return confirm('Voulez-vous vraiment supprimer cet historique ?')">
                                                                                Supprimer
                                                                            </button>
                                                                        </form>
                                                                    {% endif %}
                                                                </div>
                                                            </div>
                                                        </li>
                                                    {% endfor %}
                                                </ul>
                                            {% else %}
                                                <div class="alert alert-info text-center">
                                                    Aucun historique enregistré pour cette hospitalisation.
                                                </div>
                                            {% endif %}
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                                Fermer
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Button to Trigger Modal -->
                            {% if diagnostics %}

                                        <li class="d-flex justify-content-between align-items-center">
                                <button class="btn btn-outline-primary ml-2 uniform-btn" data-toggle="modal"
                                        data-target="#diagnosticModal">
                                    <em class="icon ni ni-list"></em> Diagnostics<span
                                        class="badge badge-info ml-1">{{ diagnosticscount }}</span>
                                </button>
                                        </li>{% endif %}
                            <!-- Modal Diagnostics -->
                            <div class="modal fade" id="diagnosticModal" tabindex="-1"
                                 aria-labelledby="diagnosticModalLabel" aria-hidden="true">
                                <div class="modal-dialog modal-lg">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="diagnosticModalLabel">Diagnostics Associés</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                    aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            {% if diagnostics %}
                                                <ul class="list-group">
                                                    {% for diagnostic in diagnostics %}
                                                        <li class="list-group-item">
                                                            <div class="d-flex justify-content-between align-items-center">
                                                                <div>
                                                                    <h6 class="mb-1">
                                                                        <strong>{{ diagnostic.date_diagnostic|naturaltime }}</strong>
                                                                        -
                                                                        <span class="badge bg-info text-dark">{{ diagnostic.get_type_diagnostic_display }}</span>
                                                                    </h6>
                                                                    <p class="mb-1">
                                                                        <strong>Maladie
                                                                            :</strong> {{ diagnostic.maladie }}
                                                                    </p>
                                                                    <p class="mb-1">
                                                                        <strong>Remarques
                                                                            :</strong> {{ diagnostic.remarques|safe|default:"Aucune remarque" }}
                                                                    </p>
                                                                    <p class="mb-1">
                                                                        <strong>Médecin
                                                                            :</strong> {{ diagnostic.medecin_responsable.get_full_name|default:"Inconnu" }}
                                                                    </p>
                                                                </div>
                                                                <div>
                                                                    {% if diagnostic.medecin_responsable == request.user %}
                                                                        <!-- Button to delete diagnostic -->
                                                                        <form method="post" action=""
                                                                              style="display:inline;">
                                                                            {% csrf_token %}
                                                                            <button type="submit"
                                                                                    class="btn btn-danger btn-sm"
                                                                                    onclick="return confirm('Voulez-vous vraiment supprimer ce diagnostic ?')">
                                                                                <em class="icon ni ni-trash"></em>
                                                                            </button>
                                                                        </form>
                                                                    {% endif %}
                                                                </div>
                                                            </div>
                                                        </li>
                                                    {% endfor %}
                                                </ul>
                                            {% else %}
                                                <div class="alert alert-info text-center">
                                                    Aucun diagnostic enregistré pour cette hospitalisation.
                                                </div>
                                            {% endif %}
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                                Fermer
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                                {% if antecedents_par_type %}
                                    <li class="d-flex justify-content-between align-items-center">
                                        <button class="btn btn-outline-primary ml-2 uniform-btn" data-toggle="modal"
                                                data-target="#antecedentsViewModal">
                                            <em class="icon ni ni-list"></em> Antécédents
                                            <span class="badge badge-info ml-1">{{ antecedentscount }}</span>
                                        </button>
                                    </li>
                                {% endif %}

                                <!-- Modal Affichage des Antécédents -->
                                <div class="modal fade" id="antecedentsViewModal" tabindex="-1"
                                     aria-labelledby="antecedentsModalLabel" aria-hidden="true">
                                    <div class="modal-dialog modal-lg">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="antecedentsModalLabel">Antécédents
                                                    Médicaux</h5>
                                                <button type="button" class="btn-close" data-dismiss="modal"
                                                        aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                {% if antecedents_par_type %}
                                                    <div class="accordion" id="accordionAntecedents">
                                                        {% for type_nom, antecedents in antecedents_par_type.items %}
                                                            <div class="accordion-item">
                                                                <h2 class="accordion-header"
                                                                    id="heading{{ forloop.counter }}">
                                                                    <button class="accordion-button collapsed btn btn-outline-primary uniform-btn"
                                                                            type="button" data-toggle="collapse"
                                                                            data-target="#collapse{{ forloop.counter }}"
                                                                            aria-expanded="false"
                                                                            aria-controls="collapse{{ forloop.counter }}">
                                                                        {{ type_nom }} ({{ antecedents|length }})
                                                                    </button>
                                                                </h2>
                                                                <div id="collapse{{ forloop.counter }}"
                                                                     class="accordion-collapse collapse"
                                                                     aria-labelledby="heading{{ forloop.counter }}"
                                                                     data-parent="#accordionAntecedents">
                                                                    <div class="accordion-body">
                                                                        <ul class="list-group">
                                                                            {% for antecedent in antecedents %}
                                                                                <li class="list-group-item">
                                                                                    <div class="d-flex justify-content-between align-items-center">
                                                                                        <div>
                                                                                            <h6 class="mb-1">
                                                                                                <strong>{{ antecedent.date_debut|default:"Date inconnue" }}</strong>
                                                                                                -
                                                                                                <span class="badge bg-info text-dark">{{ antecedent.nom }}</span>
                                                                                            </h6>
                                                                                            <p class="mb-1">
                                                                                                <strong>Description
                                                                                                    :</strong> {{ antecedent.descriptif|default:"Aucune description" }}
                                                                                            </p>
                                                                                        </div>
                                                                                        <div>
                                                                                            {% if request.user == antecedent.hospitalisation.medecin_responsable %}
                                                                                                <!-- Bouton Supprimer -->
                                                                                                <form method="post"
                                                                                                      action="{% url 'delete_antecedent' antecedent.id %}"
                                                                                                      style="display:inline;">
                                                                                                    {% csrf_token %}
                                                                                                    <button type="submit"
                                                                                                            class="btn btn-danger btn-sm"
                                                                                                            onclick="return confirm('Voulez-vous vraiment supprimer cet antécédent ?')">
                                                                                                        <em class="icon ni ni-trash"></em>
                                                                                                    </button>
                                                                                                </form>
                                                                                            {% endif %}
                                                                                        </div>
                                                                                    </div>
                                                                                </li>
                                                                            {% endfor %}
                                                                        </ul>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        {% endfor %}
                                                    </div>
                                                {% else %}
                                                    <div class="alert alert-info text-center">
                                                        Aucun antécédent enregistré pour cette hospitalisation.
                                                    </div>
                                                {% endif %}
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                                    Fermer
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {% if modedevies_by_categories %}
                                    <li class="d-flex justify-content-between align-items-center">
                                        <button class="btn btn-outline-primary ml-2 uniform-btn" data-toggle="modal"
                                                data-target="#modeDeVieviewModal">
                                            <em class="icon ni ni-list"></em> Mode de vies
                                            <span class="badge badge-info ml-1">{{ modedevies_count }}</span>
                                        </button>
                                    </li>
                                {% endif %}


                                <!-- Modal d'Affichage des Modes de Vie -->
                                <div class="modal fade" id="modeDeVieviewModal" tabindex="-1"
                                     aria-labelledby="modeDeVieModalLabel" aria-hidden="true">
                                    <div class="modal-dialog modal-lg">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">Modes de Vie du Patient</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                        aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                {% if modedevies_by_categories %}
                                                    <div class="accordion" id="accordionModeDeVie">
                                                        {% for categorie, modedevies in modedevies_by_categories.items %}
                                                            <div class="accordion-item">
                                                                <h2 class="accordion-header"
                                                                    id="heading{{ forloop.counter }}">
                                                                    <button class="accordion-button collapsed btn btn-outline-primary uniform-btn "
                                                                            type="button"
                                                                            data-bs-toggle="collapse"
                                                                            data-bs-target="#collapse{{ forloop.counter }}"
                                                                            aria-expanded="false"
                                                                            aria-controls="collapse{{ forloop.counter }}">
                                                                        {{ categorie }} ({{ modedevies|length }})
                                                                    </button>
                                                                </h2>
                                                                <div id="collapse{{ forloop.counter }}"
                                                                     class="accordion-collapse collapse"
                                                                     aria-labelledby="heading{{ forloop.counter }}"
                                                                     data-bs-parent="#accordionModeDeVie">
                                                                    <div class="accordion-body">
                                                                        <ul class="list-group">
                                                                            {% for mode in modedevies %}
                                                                                <li class="list-group-item">
                                                                                    <div class="d-flex justify-content-between align-items-center">
                                                                                        <div>
                                                                                            <h6 class="mb-1">
                                                                                                <strong>{{ mode.date_enregistrement|date:"d M Y" }}</strong>
                                                                                                -
                                                                                                <span class="badge bg-info text-dark">{{ mode.get_frequence_display }}</span>
                                                                                            </h6>
                                                                                            <p class="mb-1"><strong>Description
                                                                                                :</strong> {{ mode.description|default:"Aucune description" }}
                                                                                            </p>
                                                                                            <p class="mb-1"><strong>Impact
                                                                                                :</strong> {{ mode.get_niveau_impact_display }}
                                                                                            </p>
                                                                                        </div>
                                                                                        <div>
                                                                                            <form method="post"
                                                                                                  action=""
                                                                                                  style="display:inline;">
                                                                                                {% csrf_token %}
                                                                                                <button type="submit"
                                                                                                        class="btn btn-danger btn-sm"
                                                                                                        onclick="return confirm('Voulez-vous vraiment supprimer ce mode de vie ?')">
                                                                                                    <em class="icon ni ni-trash"></em>
                                                                                                </button>
                                                                                            </form>
                                                                                        </div>
                                                                                    </div>
                                                                                </li>
                                                                            {% endfor %}
                                                                        </ul>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        {% endfor %}
                                                    </div>
                                                {% else %}
                                                    <div class="alert alert-info text-center">
                                                        Aucun mode de vie enregistré pour cette hospitalisation.
                                                    </div>
                                                {% endif %}
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                                    Fermer
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>


                                {% if avis_medicaux %}
                                 <li class="d-flex justify-content-between align-items-center">
                                <button class="btn btn-outline-primary ml-2 uniform-btn" data-toggle="modal"
                                        data-target="#voiravisMedicalModal">
                                    <em class="icon ni ni-edit-alt"></em> Avis medical<span
                                        class="badge badge-info ml-1">{{ avis_medicauxcount }}</span>
                                </button></li>
                            {% endif %}
                            <div class="modal fade" id="voiravisMedicalModal" tabindex="-1" aria-hidden="true">
                                <div class="modal-dialog modal-lg">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">Avis Médicaux</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                    aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <input type="text" id="searchAvis" class="form-control mb-3"
                                                   placeholder="Rechercher un avis médical">
                                            <div id="avisMedicalList">
                                                {% for avis in avis_medicaux %}
                                                    <div class="card mb-3 avis-card">
                                                        <div class="card-header">
                                                            <strong>{{ avis.medecin.get_full_name }}</strong> -
                                                            <em>{{ avis.date_avis|date:"d/m/Y H:i" }}</em>
                                                        </div>
                                                        <div class="card-body">
                                                            <p>{{ avis.contenu|safe }}</p>
                                                            <small>Par : {{ avis.medecin.get_full_name }}</small>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <script>
                                document.addEventListener('DOMContentLoaded', function () {
                                    const searchInput = document.getElementById('searchAvis');
                                    const avisCards = document.querySelectorAll('.avis-card');

                                    searchInput.addEventListener('input', function () {
                                        const searchValue = searchInput.value.toLowerCase();

                                        avisCards.forEach(card => {
                                            const title = card.querySelector('.card-header strong').innerText.toLowerCase();
                                            const content = card.querySelector('.card-body p').innerText.toLowerCase();

                                            if (title.includes(searchValue) || content.includes(searchValue)) {
                                                card.style.display = '';
                                            } else {
                                                card.style.display = 'none';
                                            }
                                        });
                                    });
                                });
                            </script>
                            {% if effets_indesirables %}
                                 <li class="d-flex justify-content-between align-items-center">
                                <button class="btn btn-outline-primary ml-2 uniform-btn" data-toggle="modal"
                                        data-target="#effetIndesirableModal">
                                    <em class="icon ni ni-edit-alt"></em> Effets indesirables <span
                                        class="badge badge-info">{{ effets_indesirablescount }}</span>
                                </button></li>
                            {% endif %}

                            <div class="modal fade" id="effetIndesirableModal" tabindex="-1" aria-hidden="true">
                                <div class="modal-dialog modal-lg">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">Effets Indésirables</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <input type="text" id="searchEffetsIndesirables" class="form-control mb-3"
                                                   placeholder="Rechercher un effet indésirable">
                                            <div id="effetsIndesirablesList">
                                                {% for effet in effets_indesirables %}
                                                    <div class="card mb-3 effet-card">
                                                        <div class="card-header">
                                                            <strong>Gravité : {{ effet.gravite }}</strong> -
                                                            <em>{{ effet.date_apparition|date:"d/m/Y" }}</em>
                                                        </div>
                                                        <div class="card-body">
                                                            <p><strong>Description : </strong>{{ effet.description }}
                                                            </p>
                                                            <p><strong>Médicament associé
                                                                : </strong>{{ effet.medicament_associe.nom|default:"Non spécifié" }}
                                                            </p>
                                                            <small>Signalé par
                                                                : {{ effet.medecin.get_full_name|default:"Non spécifié" }}</small>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <script>
                                document.addEventListener('DOMContentLoaded', function () {
                                    const searchInput = document.getElementById('searchEffetsIndesirables');
                                    const effetCards = document.querySelectorAll('.effet-card');

                                    searchInput.addEventListener('input', function () {
                                        const searchValue = searchInput.value.toLowerCase();

                                        effetCards.forEach(card => {
                                            const description = card.querySelector('.card-body').innerText.toLowerCase();

                                            if (description.includes(searchValue)) {
                                                card.style.display = '';
                                            } else {
                                                card.style.display = 'none';
                                            }
                                        });
                                    });
                                });
                            </script>
                            {% if hopi_comment %}
                                 <li class="d-flex justify-content-between align-items-center">
                                <button class="btn btn-outline-primary ml-2 uniform-btn" data-toggle="modal"
                                        data-target="#commentairesModal">
                                    <em class="icon ni ni-edit-alt"></em>Comment. <span
                                        class="badge badge-info">{{ hopi_commentcount }}</span>
                                </button></li>
                            {% endif %}

                            <div class="modal fade" id="commentairesModal" tabindex="-1" aria-hidden="true">
                                <div class="modal-dialog modal-lg">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">Commentaires des medecins </h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                    aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <!-- Champ de recherche -->
                                            <input type="text" id="searchComment" class="form-control mb-3"
                                                   placeholder="Rechercher un commentaire">

                                            <!-- Liste des commentaires -->
                                            <div id="commentList">
                                                {% if hopi_comment %}
                                                    {% for comment in hopi_comment %}
                                                        <div class="card mb-3 comment-card">
                                                            <div class="card-header">
                                                                <strong>{{ comment.medecin|default:"auteur inconnu" }}</strong>
                                                                -
                                                                <em>{{ comment.date_commentaire|naturaltime }}</em>
                                                            </div>
                                                            <div class="card-body">
                                                                <p>{{ comment.contenu }}</p>
                                                            </div>
                                                        </div>
                                                    {% endfor %}
                                                {% else %}
                                                    <p>Aucun commentaire disponible.</p>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <script>
                                document.addEventListener('DOMContentLoaded', function () {
                                    const searchInput = document.getElementById('searchComment');
                                    const commentCards = document.querySelectorAll('.comment-card');

                                    searchInput.addEventListener('input', function () {
                                        const searchValue = searchInput.value.toLowerCase();

                                        commentCards.forEach(card => {
                                            const content = card.querySelector('.card-body').innerText.toLowerCase();

                                            if (content.includes(searchValue)) {
                                                card.style.display = '';
                                            } else {
                                                card.style.display = 'none';
                                            }
                                        });
                                    });
                                });
                            </script>


                            <!-- Modal Content Code -->
                            <div class="modal fade" tabindex="-1" id="hospitalisationout">
                                <div class="modal-dialog modal-lg" role="document">
                                    <div class="modal-content ">
                                        <a href="#" class="close" data-dismiss="modal" aria-label="Close">
                                            <em class="icon ni ni-cross"></em>
                                        </a>
                                        <div class="modal-header">
                                            <h5 class="modal-title">Hospitalisation
                                                Patient: {{ hospitalisationdetail.patient }}</h5>
                                        </div>
                                        <div class="modal-body">
                                            <form method="POST"
                                                  action="{% url 'update_hospitalisation_discharge' hospitalisation_id=hospitalisationdetail.id %}">
                                                {% csrf_token %}
                                                <div class="form-group">
                                                    <label for="discharge_date">Date et heure de sortie</label>
                                                    <input type="datetime-local" class="form-control"
                                                           id="discharge_date"
                                                           name="discharge_date" required>
                                                </div>

                                                <div class="form-group">
                                                    <label for="status">Mode de sortie</label>
                                                    <select class="form-control" id="status" name="status" required>
                                                        <option value="Sortie">Sortie</option>
                                                        <option value="Gueris-EXEA">Gueris-EXEA</option>
                                                        <option value="Transféré-TRANSF">Transféré-TRANSF</option>
                                                        <option value="SCAM">SCAM</option>
                                                        <option value="EVADE">EVADE</option>
                                                        <option value="DCD">DCD</option>
                                                        <!-- Add other status options if needed -->
                                                    </select>
                                                </div>
                                                <div class="form-group">
                                                    <label for="discharge_reason">Commentaires</label>
                                                    <textarea class="form-control" id="discharge_reason" name="discharge_reason" rows="4" required></textarea>
                                                </div>
                                                <button type="submit" class="btn btn-primary">Sortir</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
</ul>
                        </div>



                    </div>


                <div class="nk-block">
                <div class="card card-bordered card-stretch">
                        <div class="card-inner-group">
                            <div class="row pl-2 pr-2 pb-5">
                            {% if hospitalisationdetail.discharge_date  %}
                                {% else %}

                                <div class="col-lg-3 text-end">
                                <ul class="m-0 p-0 list-unstyled text-end">
                                      <!-- Historique Maladie -->
                                         <li class="d-flex justify-content-between align-items-center">
                                            <button type="button" class="btn btn-primary uniform-btn  mt-2"
                                                    data-toggle="modal" data-target="#addhistoireModal">
                                                <em class="icon ni ni-plus-circle-fill"></em> Histoire maladie
                                            </button>
                                             <div class="modal fade" id="addhistoireModal"  data-backdrop="static"   role="dialog" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Historique de la maladie</h5>
                 <a href="#" class="close" data-dismiss="modal" aria-label="Close">
                <em class="icon ni ni-cross"></em>
            </a>

            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'add_historique_maladie' hospitalisation_id=hospitalisationdetail.id  %}">
                    {% csrf_token %}
                    {{ historiquemaladieform.as_p }}
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </form>
            </div>
        </div>
    </div>
                                                  <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Reinitialiser TinyMCE quand le modal est affiché
            $('#addhistoireModal').on('shown.bs.modal', function () {
                tinymce.remove(); // Supprimer les anciennes instances (si rechargé)
                tinymce.init({
                    selector: '.tinymce-effet',
                    plugins: 'advlist autolink lists link charmap print preview anchor image media table paste wordcount',
                    toolbar: 'bold italic underline | alignleft aligncenter alignright | bullist numlist outdent indent',
                    menubar: false,
                    height: 300,
                    browser_spellcheck: true,
                    contextmenu: false ,
                });
            });
        });
    </script>
</div>

                                        </li>
                                     <!-- Button antecedent  -->
               <li class="d-flex justify-content-between align-items-center">
    <button type="button" class="btn btn-primary uniform-btn mt-2"
            data-toggle="modal" data-target="#antecedentsModal">
        <em class="icon ni ni-plus-circle-fill"></em> Antécédents
    </button>

    <!-- Modal -->
    <div class="modal fade" id="antecedentsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Antécédents Médicaux</h5>
                    <button type="button" class="btn-close" data-dismiss="modal"></button>
                </div>
                <div class="modal-body">

                    <form method="post" action="{% url 'add_antecedent_hospi' hospitalisation_id=hospitalisationdetail.id %}">
                        {% csrf_token %}

                        <!-- Initialisation Alpine.js avec les types chargés dynamiquement -->
                        <div x-data="antecedentsForm(JSON.parse('{{ types_antecedents_json|safe|escapejs }}'))">
                            <template x-for="(group, index) in groups" :key="index">
                                <div class="mb-4 p-3 border rounded">
                                    <h5 x-text="group.label" class="mb-3"></h5>

                                    <template x-for="(antecedent, idx) in group.antecedents" :key="idx">
                                        <div class="mb-3">
                                            <input type="hidden" :name="'type_' + index + '_' + idx" x-model="group.id">

                                            <input type="text" class="form-control mb-2" placeholder="Nom"
                                                   :name="'nom_' + index + '_' + idx" x-model="antecedent.nom">

                                            <input type="text" class="form-control mb-2" placeholder="Description"
                                                   :name="'descriptif_' + index + '_' + idx"
                                                   x-model="antecedent.descriptif">

                                            <input type="date" class="form-control mb-2"
                                                   :name="'date_debut_' + index + '_' + idx"
                                                   x-model="antecedent.date_debut">

                                            <button type="button" class="btn btn-danger btn-sm"
                                                    @click="removeAntecedent(index, idx)">Supprimer
                                            </button>
                                        </div>
                                    </template>

                                    <button type="button" class="btn btn-success btn-sm"
                                            @click="addAntecedent(index)">Ajouter un champ
                                    </button>
                                </div>
                            </template>
                        </div>

                        <button type="submit" class="btn btn-primary mt-3">Enregistrer</button>
                    </form>

                </div>
            </div>
        </div>
    </div>
</li>

<!-- Alpine.js Script -->
<script>
    function antecedentsForm(typesAntecedents) {
        return {
            groups: typesAntecedents.map(type => ({
                label: type.nom,  // Utilisation du nom du type
                id: type.id,  // ID du type pour la relation ForeignKey
                antecedents: [{ nom: "", descriptif: "", date_debut: "" }]
            })),
            addAntecedent(index) {
                this.groups[index].antecedents.push({ nom: "", descriptif: "", date_debut: "" });
            },
            removeAntecedent(index, idx) {
                if (this.groups[index].antecedents.length > 1) {
                    this.groups[index].antecedents.splice(idx, 1);
                }
            }
        };
    }
</script>

 <!-- Mode de vie  -->
<li class="d-flex justify-content-between align-items-center">
    <button type="button" class="btn btn-primary uniform-btn mt-2"
            data-bs-toggle="modal" data-bs-target="#modeDeVieModal">
        <em class="icon ni ni-plus-circle-fill"></em> Mode de Vie
    </button>

    <!-- Modal -->
    <div class="modal fade" id="modeDeVieModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Mode de Vie du Patient</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">

                    <form method="post" action="{% url 'ajouter_mode_de_vie' hospitalisation_id=hospitalisationdetail.id %}">
                        {% csrf_token %}

                        <!-- Initialisation Alpine.js -->
                        <div x-data="modeDeVieForm(JSON.parse('{{ categorie_modedevie_json|safe|escapejs }}'))">
                            <template x-for="(group, index) in groups" :key="index">
                                <div class="mb-4 p-3 border rounded">
                                    <h5 x-text="group.label" class="mb-3"></h5>

                                    <template x-for="(mode, idx) in group.modes" :key="idx">
                                        <div class="mb-3">
                                            <input type="hidden"
                                                   :name="'categorie_' + index + '_' + idx"
                                                   x-model="group.id">

                                            <select class="form-control mb-2"
                                                    :name="'frequence_' + index + '_' + idx"
                                                    x-model="mode.frequence">
                                                <option value="">Sélectionner la fréquence</option>
                                                <option value="quotidien">Quotidien</option>
                                                <option value="hebdomadaire">Hebdomadaire</option>
                                                <option value="mensuel">Mensuel</option>
                                                <option value="occasionnel">Occasionnel</option>
                                                <option value="rare">Rare</option>
                                            </select>

                                            <select class="form-control mb-2"
                                                    :name="'impact_' + index + '_' + idx"
                                                    x-model="mode.impact">
                                                <option value="">Impact sur la santé</option>
                                                <option value="faible">Faible</option>
                                                <option value="modéré">Modéré</option>
                                                <option value="élevé">Élevé</option>
                                            </select>

                                            <textarea class="form-control mb-2"
                                                      placeholder="Détails"
                                                      :name="'description_' + index + '_' + idx"
                                                      x-model="mode.description"></textarea>

                                            <button type="button"
                                                    class="btn btn-danger btn-sm"
                                                    @click="removeMode(index, idx)">
                                                Supprimer
                                            </button>
                                        </div>
                                    </template>

                                    <button type="button"
                                            class="btn btn-success btn-sm"
                                            @click="addMode(index)">Ajouter un champ
                                    </button>
                                </div>
                            </template>
                        </div>

                        <button type="submit" class="btn btn-primary mt-3">
                            Enregistrer
                        </button>
                    </form>

                </div>
            </div>
        </div>
    </div>
</li>

<!-- Alpine.js Script -->
<script>
    function modeDeVieForm(categories) {
        return {
            groups: categories.map(cat => ({
                label: cat.nom,  // Nom de la catégorie
                id: cat.id,  // ID de la catégorie
                modes: [{ description: "", frequence: "", impact: "" }]
            })),
            addMode(index) {
                this.groups[index].modes.push({
                    description: "",
                    frequence: "",
                    impact: ""
                });
            },
            removeMode(index, idx) {
                if (this.groups[index].modes.length > 1) {
                    this.groups[index].modes.splice(idx, 1);
                }
            }
        };
    }
</script>


                                </ul>
                                </div>
                                <div class="col-lg-3 text-end">
                                    <ul class="m-0 p-0 list-unstyled text-end">
                                         <!-- Examen Physique  -->
                                        <li class="d-flex justify-content-between align-items-center">
        <button type="button" class="btn btn-success  uniform-btn mt-2"
                data-toggle="modal" data-target="#examensphysiqueModal">
            <em class="icon ni ni-plus-circle-fill"></em> Examens Physiques
        </button>
        <div class="modal fade" id="examensphysiqueModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Examens des Apareils</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
            <form method="post" action="{% url 'add_examen_apareil' hospitalisation_id=hospitalisationdetail.id %}">
    {% csrf_token %}

    <div x-data="appareilForm(JSON.parse('{{ types_appareils_json|safe|escapejs }}'))">
        <template x-for="(group, index) in groups" :key="index">
            <div class="mb-4 p-3 border rounded">
                <h5 x-text="group.label" class="mb-3"></h5>

                <template x-for="(sousType, idx) in group.sous_types" :key="idx">
                    <div class="mb-3 p-2 border rounded bg-light">
                        <h6 x-text="sousType.nom" class="mb-2 text-primary"></h6>

                        <input type="hidden" :name="'type_appareil_' + index + '_' + idx" x-model="sousType.id">

                        <input type="text" class="form-control mb-2" placeholder="Nom de l'Appareil"
                               :name="'nom_' + index + '_' + idx" x-model="sousType.nom" required>

                        <select class="form-control mb-2" :name="'etat_' + index + '_' + idx" x-model="sousType.etat">
                            <option value="normal">Normal</option>
                            <option value="altéré">Altéré</option>
                            <option value="anormal">Anormal</option>
                            <option value="non-applicable">Non-applicable</option>
                        </select>

                        <textarea class="form-control mb-2" placeholder="Détails de l'examen"
                                  :name="'observation_' + index + '_' + idx" x-model="sousType.observation"></textarea>

                        <button type="button" class="btn btn-danger btn-sm"
                                @click="removeAppareil(index, idx)">Supprimer</button>
                    </div>
                </template>

                <button type="button" class="btn btn-success btn-sm"
                        @click="addAppareil(index)">Ajouter un champ</button>
            </div>
        </template>
    </div>

    <button type="submit" class="btn btn-primary mt-3">Enregistrer</button>
</form>
                <!-- Alpine.js Script -->
<script>
    function appareilForm(typesAppareils) {
        return {
            groups: typesAppareils.map(type => ({
                label: type.nom,  // Nom du type parent
                id: type.id,  // ID du type parent
                sous_types: type.sous_types.map(sous_type => ({
                    id: sous_type.id,
                    nom: sous_type.nom,
                    etat: "normal",
                    observation: ""
                }))
            })),
            addAppareil(index) {
                this.groups[index].sous_types.push({
                    id: null,
                    nom: "",
                    etat: "normal",
                    observation: ""
                });
            },
            removeAppareil(index, idx) {
                if (this.groups[index].sous_types.length > 1) {
                    this.groups[index].sous_types.splice(idx, 1);
                }
            }
        };
    }
</script>
            </div>
        </div>
    </div>
</div>
        <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Reinitialiser TinyMCE quand le modal est affiché
            $('#addeffetindesirableModal').on('shown.bs.modal', function () {
                tinymce.remove(); // Supprimer les anciennes instances (si rechargé)
                tinymce.init({
                    selector: '.tinymce-effet',
                    plugins: 'advlist autolink lists link charmap print preview anchor',
                    toolbar: 'bold italic underline | alignleft aligncenter alignright | bullist numlist outdent indent',
                    menubar: false,
                    height: 300,
                });
            });
        });
    </script>
    </li>

                                         <!-- Resume Syndromique  -->
                                         <li class="d-flex justify-content-between align-items-center">
        <button type="button" class="btn btn-success  uniform-btn mt-2"
                data-toggle="modal" data-target="#resumesyndromiqueModal">
            <em class="icon ni ni-plus-circle-fill"></em> Résumés Syndromique
        </button>
        <div class="modal fade" id="resumesyndromiqueModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ajouter un résumé</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'add_resume_syndromique' hospitalisation_id=hospitalisationdetail.id  %}">
                    {% csrf_token %}
                    {{ resumesyndromiqueform.as_p }}
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </form>
            </div>
        </div>
    </div>
</div>
        <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Reinitialiser TinyMCE quand le modal est affiché
            $('#resumesyndromiqueModal').on('shown.bs.modal', function () {
                tinymce.remove(); // Supprimer les anciennes instances (si rechargé)
                tinymce.init({
                    selector: '.tinymce-effet',
                    plugins: 'advlist autolink lists link charmap print preview anchor',
                    toolbar: 'bold italic underline | alignleft aligncenter alignright | bullist numlist outdent indent',
                    menubar: false,
                    height: 300,
                });
            });
        });
    </script>
    </li>

                                        <!-- Problemes posés  -->
                                         <li class="d-flex justify-content-between align-items-center">
        <button type="button" class="btn btn-success  uniform-btn mt-2"
                data-toggle="modal" data-target="#problemesposerModal">
            <em class="icon ni ni-plus-circle-fill"></em>Problèmes posés
        </button>
        <div class="modal fade" id="problemesposerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Rediger le Problèmes</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'add_problemes_pose' hospitalisation_id=hospitalisationdetail.id  %}">
                    {% csrf_token %}
                    {{ problemesposerform.as_p }}
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </form>
            </div>
        </div>
    </div>
</div>
        <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Reinitialiser TinyMCE quand le modal est affiché
            $('#problemesposerModal').on('shown.bs.modal', function () {
                tinymce.remove(); // Supprimer les anciennes instances (si rechargé)
                tinymce.init({
                    selector: '.tinymce-effet',
                    plugins: 'advlist autolink lists link charmap print preview anchor',
                    toolbar: 'bold italic underline | alignleft aligncenter alignright | bullist numlist outdent indent',
                    menubar: false,
                    height: 300,
                });
            });
        });
    </script>
    </li>

                                    </ul>

                                </div>
                                <div class="col-lg-3 text-end">

                                   <ul class="m-0 p-0 list-unstyled text-end">

 <!-- Bilan Paraclinique -->
    <li class="d-flex justify-content-between align-items-center">
        <button type="button" class="btn btn-danger  uniform-btn mt-2"
                data-toggle="modal" data-target="#bilanModal">
            <em class="icon ni ni-plus-circle-fill"></em> Bilan Paraclinique
        </button>

        <div class="modal fade" id="bilanModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ajouter des Examens Paracliniques</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form @submit.prevent="submitForm">
    {% csrf_token %}

    <div x-data="bilanForm(JSON.parse('{{ types_examens_json|safe|escapejs }}'))">
        <template x-for="(type, index) in types" :key="index">
            <div class="mb-4 p-3 border rounded">
                <h5 class="mb-3 text-primary" x-text="type.nom"></h5>

                <template x-for="(examen, idx) in type.examens" :key="idx">
                    <label class="d-flex align-items-center mb-4">
                        <input type="checkbox" class="form-check-input custom-checkbox me-2"
                               :value="examen.id"
                               x-model="selectedExamens">
                        <span x-text="examen.nom" class="ml-3"></span>
                    </label>
                </template>
            </div>
        </template>

        <!-- Bouton d'enregistrement -->
        <div class="text-center mt-4">
            <button type="submit" class="btn btn-primary" @click.prevent="submitForm">
                Enregistrer les examens
            </button>
        </div>
    </div>
</form>
            </div>
        </div>
    </div>
</div>
        <script>
  function bilanForm(data) {
    return {
        types: data,  // Liste des types d'examens et examens associés
        selectedExamens: [],  // Examens sélectionnés

        submitForm() {
            if (this.selectedExamens.length === 0) {
                alert("Veuillez sélectionner au moins un examen.");
                return;
            }

            let formData = new FormData();
            formData.append("csrfmiddlewaretoken", document.querySelector("[name=csrfmiddlewaretoken]").value);

            this.selectedExamens.forEach(id => {
                formData.append("examens", id);
            });

            let url = "{% url 'add_bilan_paraclinique' hospitalisation_id=0 %}".replace("0", "{{ hospitalisationdetail.id }}");

            fetch(url, {
                method: "POST",
                body: formData,
                headers: {
                    "X-Requested-With": "XMLHttpRequest"
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                alert("Erreur lors de l'enregistrement : " + error);
            });
        }
    };
}
</script>
    </li>
     <!-- Imagerie -->
    <li class="d-flex justify-content-between align-items-center">
        <button type="button" class="btn btn-danger  uniform-btn mt-2"
                data-toggle="modal" data-target="#imagerieModal">
            <em class="icon ni ni-plus-circle-fill"></em> Imagerie
        </button>

        <div class="modal fade" id="imagerieModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ajouter une Imagerie</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form @submit.prevent="submitForm">
                    {% csrf_token %}

                    <div x-data="imagerieForm(JSON.parse('{{ types_imagerie_json|safe|escapejs }}'))">
                        <label>Type d'Imagerie :</label>
                        <select class="form-select mb-3" x-model="selectedType">
                            <template x-for="(type, index) in types" :key="index">
                                <option :value="type.id" x-text="type.nom"></option>
                            </template>
                        </select>

                        <label>Motif :</label>
                        <textarea class="form-control mb-3" x-model="prescription"></textarea>

                        <label>Fichier Image :</label>
                        <input type="file" class="form-control mb-3" @change="handleFileUpload">

                        <!-- Bouton d'enregistrement -->
                        <div class="text-center mt-4">
                            <button type="submit" class="btn btn-primary">
                                Enregistrer l'Imagerie
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    function imagerieForm(types) {
        return {
            types: types,
            selectedType: '',
            prescription: '',
            imageFile: null,

            handleFileUpload(event) {
                this.imageFile = event.target.files[0];
            },

            submitForm() {
                if (!this.selectedType) {
                    alert("Veuillez sélectionner un type d'imagerie.");
                    return;
                }

                let formData = new FormData();
                formData.append("csrfmiddlewaretoken", document.querySelector("[name=csrfmiddlewaretoken]").value);
                formData.append("type_imagerie", this.selectedType);
                formData.append("prescription", this.prescription);
                if (this.imageFile) {
                    formData.append("image_file", this.imageFile);
                }

                fetch("{% url 'add_imagerie' hospitalisation_id=hospitalisationdetail.id %}", {
                    method: "POST",
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        location.reload();
                    } else {
                        alert("Erreur lors de l'enregistrement.");
                    }
                });
            }
        };
    }
</script>

    </li>

  <!-- Diagnostique -->
 <li class="d-flex justify-content-between align-items-center">
        <button type="button" class="btn btn-danger  uniform-btn mt-2" data-toggle="modal" data-target="#adddiagnosticModal">
            <em class="icon ni ni-plus-circle-fill"></em> Diagnostic
        </button>

   <div class="modal fade" id="adddiagnosticModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ajouter un Diagnostic</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'add_diagnostic' hospitalisation_id=hospitalisationdetail.id  %}">
                    {% csrf_token %}
                    {{ diagnosticsform.as_p }}
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </form>
            </div>
        </div>
    </div>
</div>
    </li>



</ul>

                                </div>
                                <div class="col-lg-3 text-end">

                       <ul class="m-0 p-0 list-unstyled text-end">
  <!-- avis medical -->
    <li class="d-flex justify-content-between align-items-center">
        <button type="button" class="btn btn-light  uniform-btn mt-2"
                data-toggle="modal" data-target="#addavisModal">
            <em class="icon ni ni-plus-circle-fill"></em> Avis médical
        </button>

        <div class="modal fade" id="addavisModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ajouter un Avi medical</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'add_avis_medical' hospitalisation_id=hospitalisationdetail.id  %}">
                    {% csrf_token %}
                    {{ avismedicalform.as_p }}
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </form>
            </div>
        </div>
    </div>
</div>
        <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Reinitialiser TinyMCE quand le modal est affiché
            $('#addavisModal').on('shown.bs.modal', function () {
                tinymce.remove(); // Supprimer les anciennes instances (si rechargé)
                tinymce.init({
                    selector: '.tinymce-avis',
                    plugins: 'advlist autolink lists link charmap print preview anchor',
                    toolbar: 'bold italic underline | alignleft aligncenter alignright | bullist numlist outdent indent',
                    menubar: false,
                    height: 300,
                });
            });
        });
    </script>
    </li>

  <!-- effet indesirable -->
    <li class="d-flex justify-content-between align-items-center">
        <button type="button" class="btn btn-light uniform-btn mt-2"
                data-toggle="modal" data-target="#addeffetindesirableModal">
            <em class="icon ni ni-plus-circle-fill"></em> Effet indésirable
        </button>
        <div class="modal fade" id="addeffetindesirableModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ajouter un effet indesirable</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'add_effet_indesirable' hospitalisation_id=hospitalisationdetail.id  %}">
                    {% csrf_token %}
                    {{ effetindesirableform.as_p }}
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </form>
            </div>
        </div>
    </div>
</div>
        <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Reinitialiser TinyMCE quand le modal est affiché
            $('#addeffetindesirableModal').on('shown.bs.modal', function () {
                tinymce.remove(); // Supprimer les anciennes instances (si rechargé)
                tinymce.init({
                    selector: '.tinymce-effet',
                    plugins: 'advlist autolink lists link charmap print preview anchor',
                    toolbar: 'bold italic underline | alignleft aligncenter alignright | bullist numlist outdent indent',
                    menubar: false,
                    height: 300,
                });
            });
        });
    </script>
    </li>
                             <!-- Commentaire -->
   <li class="d-flex justify-content-between align-items-center">
        <button type="button" class="btn btn-light  uniform-btn mt-2"
                data-toggle="modal" data-target="#addcommentModal">
            <em class="icon ni ni-plus-circle-fill"></em> Commentaire / update
        </button>
                    <div class="modal fade" id="addcommentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ajouter un commentaire</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'add_coment' hospitalisation_id=hospitalisationdetail.id  %}">
                    {% csrf_token %}
                    {{ hospicomment.as_p }}
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </form>
            </div>
        </div>
    </div>
</div>

    </li>
</ul>

                                </div>
                             {% endif %}

                            </div>
                            <div class="row">
                                <!-- Médicament manqué -->
                                <div class="col-lg-6 mx-auto">
    {% if missed_executions %}
        <div class="card shadow-sm border-0 bg-light rounded-lg">
            <div class="card-body">
                <h5 class="text-danger font-weight-bold ">
                    Médicaments Non Pris
                </h5>
                <div class="scrollable-container" style="max-height: 200px; overflow-y: auto;">
                    <ul class="list-group">
                        {% for execution in missed_executions %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>{{ execution.prescription.medication }}</strong>
                                    <br>
                                    <span class="text-muted">Heure prévue : {{ execution.scheduled_time|date:"d/m/Y H:i" }}</span>
                                </div>
                                <span class="badge bg-danger text-white">Non pris</span>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    {% else %}
        <div class="card shadow-sm border-0 bg-success text-white rounded-lg p-4">
            <div class="card-body text-center">
                <h5 class="font-weight-bold">Aucune Prise Manquée</h5>
                <p class="mt-2">Toutes les prescriptions ont été suivies à temps.</p>
            </div>
        </div>
    {% endif %}
</div>
                                <div class="col-lg-6 mx-auto">
                                    {% if next_execution %}
                                        <div class="card shadow-sm border-0 bg-light rounded-lg p-4">
                                            <div class="card-body text-center">
                                                <h5 class="text-primary font-weight-bold">Prochaine Prise de
                                                    Médicament</h5>
                                                <h4 class="text-dark mt-3">{{ next_execution.prescription.medication }}</h4>
                                                <p class="text-muted">Date et heure prévue :
                                                    <strong>{{ next_execution.scheduled_time|date:"d/m/Y H:i"  }}</strong>
                                                </p>
                                                <div class="mt-4">
                                                    <div id="countdown"
                                                         class="display-4 text-warning font-weight-bold"></div>
                                                </div>
                                            </div>
                                        </div>
                                    {% else %}
                                        <div class="card shadow-sm border-0 bg-success text-white rounded-lg p-4">
                                            <div class="card-body text-center">
                                                <h5 class="font-weight-bold">Aucun Médicament Prévu</h5>
                                                <p class="mt-2">Tous les médicaments prescrits ont été administrés ou
                                                    aucune prescription n'est en attente.</p>
                                            </div>
                                        </div>
                                    {% endif %}
                                </div>
                            <script>
    {% if next_execution %}
        // Récupère la date de la prochaine exécution
        const nextExecutionTime = new Date("{{ next_execution.scheduled_time|date:'Y-m-d H:i:s' }}").getTime();
        const countdownElement = document.getElementById("countdown");

        const countdown = setInterval(function () {
            const now = new Date().getTime();
            const distance = nextExecutionTime - now;

            if (distance <= 0) {
                clearInterval(countdown);
                countdownElement.innerHTML = "Prise de médicament en cours ou en retard.";

                // ⚠️ Lancer la requête AJAX pour marquer comme "Missed"
                updateMissedExecution("{{ next_execution.id }}");
            } else {
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                countdownElement.innerHTML = `${hours}h ${minutes}m ${seconds}s`;
            }
        }, 1000);

        // Fonction AJAX pour mettre à jour le statut en "Missed"
        function updateMissedExecution(executionId) {
            fetch("{% url 'update_execution_status' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify({
                    execution_id: executionId,
                    new_status: "Missed"
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("La prise de médicament a été marquée comme 'Missed'.");
                    location.reload();  // Recharge la page pour afficher la mise à jour
                } else {
                    console.error("Erreur de mise à jour :", data.message);
                }
            })
            .catch(error => console.error("Erreur AJAX :", error));
        }
    {% endif %}
</script>
{#                                <script>#}
{#                                    {% if next_execution %}#}
{#                                        // Script pour le compte à rebours#}
{#                                        const nextExecutionTime = new Date("{{ next_execution.scheduled_time|date:"Y-m-d H:i:s" }}").getTime();#}
{#                                        const countdownElement = document.getElementById("countdown");#}
{##}
{#                                        const countdown = setInterval(function () {#}
{#                                            const now = new Date().getTime();#}
{#                                            const distance = nextExecutionTime - now;#}
{##}
{#                                            if (distance <= 0) {#}
{#                                                clearInterval(countdown);#}
{#                                                countdownElement.innerHTML = "Prise de médicament en cours ou en retard.";#}
{#                                            } else {#}
{#                                                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));#}
{#                                                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));#}
{#                                                const seconds = Math.floor((distance % (1000 * 60)) / 1000);#}
{##}
{#                                                countdownElement.innerHTML = `${hours}h ${minutes}m ${seconds}s`;#}
{#                                            }#}
{#                                        }, 1000);#}
{#                                    {% endif %}#}
{#                                </script>#}

                            </div>

                            <hr>
                            <div class="row m-4">
                                <h3 class="text-muted"> Suivie de Soins </h3>

                                <div class="row col-12">


{#                                    <canvas id="constantesChart" width="400" height="200"></canvas>#}
                                     <div class="col-xl-12" id="constantesChart"></div>


                                </div>

                                <div class="row col-12">
                                    <!-- Constantes Card -->
                                    <!-- Tableau des constantes -->
                                    <div class="col-12 col-md-12 mb-5">
                                        <div class="card text-black-100 border">
                                            <div class="card-header">
                                                Constantes
                                              {% if not hospitalisationdetail.discharge_date %}
                                                <button type="button"
                                                        class="btn btn-dark btn-icon btn-round float-right"
                                                        data-toggle="modal" data-target="#constanteModal">
                                                    <em class="icon ni ni-plus-circle-fill"></em>
                                                </button>
                                                {% endif %}
                                            </div>
                                            <div class="card-inner text-black-70">
                                                <table class="table">
                                                    <thead>
                                                    <tr>
                                                        <th>Constantes</th>
                                                        <th>Date</th>
                                                        <th>Medecin</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                    </thead>
                                                    <tbody>
                                                    {% if constantes %}
                                                        {% for constante in constantes %}
                                                            <tr class="{% if forloop.counter > 3 %}constante-data d-none{% endif %}">
                                                                <td>
                                <span class="badge badge-outline-dark">
                                    Tension: {{ constante.tension_systolique }} ts / {{ constante.tension_diastolique }} td - mmHg
                                </span><br>
                                                                    <span class="badge badge-outline-dark">Température | {{ constante.temperature }} °C</span>
                                                                </td>
                                                                <td>
                                                                    <span >{{ constante.created_at }}</span>
                                                                </td>

                                                                <td>
                                                                    <span >{{ constante.created_by }}</span>
                                                                </td>
                                                                <td>
                                <span>
                                    <a href="#" class="btn btn-primary btn-icon btn-round btn-xs"><em
                                            class="icon ni ni-eye"></em></a>
                                    <a class="btn btn-outline-info btn-icon btn-round btn-xs"
                                       href="{% url 'export_constante_pdf' hospitalisationdetail.id %}"><em
                                            class="icon ni ni-download-cloud ml-10"></em></a>
                                    <a href="#" class="btn btn-danger btn-icon btn-round btn-xs"><em
                                            class="icon ni ni-trash-fill"></em></a>
                                </span>
                                                                </td>
                                                            </tr>
                                                        {% endfor %}
                                                    {% else %}
                                                        <tr>
                                                            <td colspan="3"
                                                                style="font-style: italic; text-align: center"
                                                                class="text-white">
                                                                Aucune donnée enregistrée
                                                            </td>
                                                        </tr>
                                                    {% endif %}
                                                    </tbody>
                                                </table>
                                                <!-- Bouton pour afficher plus ou moins de données -->
                                                {% if constantes|length > 3 %}
                                                    <div class="text-center mt-3">
                                                        <button id="toggleButtonConstantes" class="btn btn-secondary">
                                                            Voir plus
                                                        </button>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>

                                    <!-- JavaScript pour le tableau des constantes -->
                                    <script>
                                        document.addEventListener('DOMContentLoaded', function () {
                                            const toggleButtonConstantes = document.getElementById('toggleButtonConstantes');
                                            const constanteDataRows = document.querySelectorAll('.constante-data');
                                            let isExpandedConstantes = false;

                                            toggleButtonConstantes.addEventListener('click', function () {
                                                if (isExpandedConstantes) {
                                                    constanteDataRows.forEach(row => row.classList.add('d-none'));
                                                    toggleButtonConstantes.textContent = 'Voir plus';
                                                } else {
                                                    constanteDataRows.forEach(row => row.classList.remove('d-none'));
                                                    toggleButtonConstantes.textContent = 'Voir moins';
                                                }
                                                isExpandedConstantes = !isExpandedConstantes;
                                            });
                                        });
                                    </script>

                                  <!-- Constante Form Modal -->
                                    <div class="modal fade" id="constanteModal" tabindex="-1"
                                         aria-labelledby="constanteModalLabel" aria-hidden="true">
                                        <div class="modal-dialog modal-lg">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="constanteModalLabel">Nouvelles
                                                        Constante</h5>
                                                    <button type="button" class="btn btn-close" data-bs-dismiss="modal"
                                                            aria-label="Close">X
                                                    </button>
                                                </div>
                                                <div class="modal-body">
                                                    <div class="row">
                                                        <form method="post" action="{% url 'hospitalisationdetails' hospitalisationdetail.id %}">
                                                            {% csrf_token %}
                                                            <div class="row">
                                                                {% for field in constante_form %}
                                                                    <div class="col-md-6 mb-3">
                                                                        <div class="form-group">
                                                                            <label class="form-label"
                                                                                   for="{{ field.id_for_label }}">{{ field.label }}</label>
                                                                            <div class="form-control-wrap">
                                                                                {{ field }}
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                {% endfor %}
                                                            </div>
                                                            <button type="submit" class="btn btn-primary float-right">
                                                                Enregistrer
                                                            </button>
                                                        </form>
                                                    </div>

                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Executes prescriptions -->
                                    <div class="col-12 col-md-12 mb-5">
    <div class="card text-black-100 border">
        <div class="card-header d-flex justify-content-between">
            <h5 class="card-title">Suivi des soins prescrits</h5>

        </div>
        <div class="card-inner text-black-70">
            <table class="table table-bordered table-responsive-md">
                <thead>
                    <tr>
                        <th>Médicament</th>
                        <th>Heure Prévue</th>
                        <th>Heure Réelle</th>
                        <th>Durée</th>
                        <th>Status</th>
                        <th>Infirmier(ère)</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for execution in executions %}
                        <tr class="{% if forloop.counter > 5 %}prescription-suivi-data d-none{% endif %}">
                            <td>{{ execution.prescription.medication.nom }}</td>
                            <td>{{ execution.scheduled_time|naturaltime }}</td>
                            <td>
                                {% if execution.executed_at %}
                                    {{ execution.executed_at|naturaltime }}
                                {% else %}
                                    Non prise
                                {% endif %}
                            </td>
                            <td>{{ execution.prescription.pendant }} Jours</td>
                            <td>
                                <span class="badge
                                    {% if execution.status == 'Pending' %}badge-warning
                                    {% elif execution.status == 'Taken' %}badge-success
                                    {% else %}badge-danger{% endif %}">
                                    {{ execution.get_status_display }}
                                </span>
                            </td>
                            <td>
                                {% if execution.executed_by %}
                                    {{ execution.executed_by }}
                                {% else %}
                                    Non attribué
                                {% endif %}
                            </td>
                            <td>
                                {% if execution.status == 'Pending' %}
                                    <form method="post" action="{% url 'mark_execution_taken' %}">
                                        {% csrf_token %}
                                        <input type="hidden" name="execution_id" value="{{ execution.id }}">
                                        <button type="submit" class="btn btn-primary btn-sm">Marquer comme pris</button>
                                    </form>
                                
                                {% else %}
                                    <button class="btn btn-secondary btn-sm" disabled>Inactif</button>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% if executions|length > 5 %}
                <div class="text-center mt-3">
                    <button id="toggleButtonPrescriptionssuivi" class="btn btn-secondary">
                        Voir plus
                    </button>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const toggleButton = document.getElementById('toggleButtonPrescriptionssuivi');
        const hiddenRows = document.querySelectorAll('.prescription-suivi-data');
        let isExpanded = false;

        toggleButton.addEventListener('click', function () {
            hiddenRows.forEach(row => row.classList.toggle('d-none'));
            isExpanded = !isExpanded;
            toggleButton.textContent = isExpanded ? 'Voir moins' : 'Voir plus';
        });
    });
</script>

                                    <!-- Prescription Card -->
                                    <!-- Tableau des prescriptions -->
                                    <div class="col-12 col-md-12 mb-5">
                                        <div class="card text-black-100 border">
                                            <div class="card-header">
                                                Prescriptions
                                                <a class="btn btn-outline-info btn-icon btn-round mr-5" href="{% url 'generate_ordonnance_pdf' patient_id=hospitalisationdetail.patient.id hospitalisation_id=hospitalisationdetail.id %}"><em class="icon ni ni-printer-fill"></em></a>
                                                {% if not hospitalisationdetail.discharge_date %}
                                                <button type="button" class="btn btn-dark btn-icon btn-round float-right" data-toggle="modal" data-target="#prescriptionModal">
                                                    <em class="icon ni ni-plus-circle-fill"></em>
                                                </button>
                                                {% endif %}
                                            </div>
                                            <div class="card-inner text-black-70">
                                                <table class="table table-responsive-md">
                                                    <thead>
                                                    <tr>

                                                        <th>Médicaments</th>
                                                        <th>Posology</th>
{#                                                        <th>Pendant</th>#}
                                                        <th>Date creation</th>
                                                        <th>Status</th>
                                                        <th>Medecin</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                    </thead>
                                                    <tbody>

                                                    {% if prescriptions %}
                                                        {% for prescription in prescriptions %}
                                                            <tr class="{% if forloop.counter > 5 %}prescription-data d-none{% endif %}">
                                                                <td>
                                                                    {% if prescription.medication.dosage_form == 'comprime' %}
                                                                        <img src="{% static 'images/comprimes.png' %}"
                                                                             width="20">
                                                                    {% elif prescription.medication.dosage_form == 'sirop' %}
                                                                        <img src="{% static 'images/sirop.png' %}"
                                                                             width="20">
                                                                    {% elif prescription.medication.dosage_form == 'injection' %}
                                                                        <img src="{% static 'images/seringue.png' %}"
                                                                             width="20">
                                                                    {% elif prescription.medication.dosage_form == 'gelule' %}
                                                                        <img src="{% static 'images/gelules.png' %}"
                                                                             width="20">
                                                                    {% elif prescription.medication.dosage_form == 'creme' %}
                                                                        <img src="{% static 'images/pommade.png' %}"
                                                                             width="20">
                                                                    {% elif prescription.medication.dosage_form == 'pommade' %}
                                                                        <img src="{% static 'images/pommade.png' %}"
                                                                             width="20">
                                                                    {% elif prescription.medication.dosage_form == 'suppositoire' %}
                                                                        <img src="{% static 'images/suppositoire.png' %}"
                                                                             width="20">
                                                                        {% elif prescription.medication.dosage_form == 'gouttes' %}
                                                                        <img src="{% static 'images/goutte-deau.png' %}"
                                                                             width="20">
                                                                    {% elif prescription.medication.dosage_form == 'patch' %}
                                                                        <img src="{% static 'images/patch.png' %}"
                                                                             width="20">
                                                                    {% elif prescription.medication.dosage_form == 'inhalateur' %}
                                                                        <img src="{% static 'images/spray-de-peinture.png' %}"
                                                                             width="20">
                                                                    {% elif prescription.medication.dosage_form == 'solution' %}
                                                                        <img src="{% static 'images/solution.png' %}"
                                                                             width="20">
                                                                    {% elif prescription.medication.dosage_form == 'suspension' %}
                                                                        <img src="{% static 'images/suspension.png' %}"
                                                                             width="20">
                                                                    {% elif prescription.medication.dosage_form == 'poudre' %}
                                                                        <img src="{% static 'images/poudre-de-talc.png' %}"
                                                                             width="20">
                                                                    {% elif prescription.medication.dosage_form == 'spray' %}
                                                                        <img src="{% static 'images/spray-de-peinture.png' %}"
                                                                             width="20">
                                                                    {% elif prescription.medication.dosage_form == 'ovule' %}
                                                                        <img src="{% static 'images/ovule.png' %}"
                                                                             width="20">
                                                                    {% elif prescription.medication.dosage_form == 'collyre' %}
                                                                        <img src="{% static 'images/collyre.png' %}"
                                                                             width="20">
                                                                    {% elif prescription.medication.dosage_form == 'aerosol' %}
                                                                        <img src="{% static 'images/aerosol.png' %}"
                                                                             width="20">
                                                                    {% elif prescription.medication.dosage_form == 'elixir' %}
                                                                        <img src="{% static 'images/elixir.png' %}"
                                                                             width="20">
                                                                    {% elif prescription.medication.dosage_form == 'baume' %}
                                                                        <img src="{% static 'images/baume.png' %}"
                                                                             width="20">
                                                                    {% elif prescription.medication.dosage_form == 'granule' %}
                                                                        <img src="{% static 'images/granule.png' %}"
                                                                             width="20">
                                                                    {% elif prescription.medication.dosage_form == 'capsule' %}
                                                                        <img src="{% static 'images/capsule.png' %}"
                                                                             width="20">
                                                                    {% endif %}
                                                                    <span class="badge badge-dark">{{ prescription.medication }}</span><br>
                                                                </td>

                                                                <td> {{ prescription.quantity }} {{ prescription.medication.dosage_form }}(s),{{ prescription.posology }}, {{ prescription.pendant }} Jours</td>
{#                                                                <td><span>{{ prescription.pendant }} Jours</span></td>#}

                                                                <td><span>{{ prescription.created_at }}</span></td>
                                                                <td>
    <span class="badge badge-xs
{% if prescription.status == 'Pending' %}badge-warning
                                    {% elif prescription.status == 'Taken' %}badge-success
                                    {% else %}badge-danger{% endif %}">
    {% if prescription.status == 'Cancelled' %}

        <span data-toggle="tooltip" data-placement="top"
              data-bs-original-title="Annuler le {{ prescription.cancellation_date }} pour motif : {{ prescription.cancellation_reason }} par : {{ prescription.cancellation_by }} ">{{ prescription.get_status_display }}</span>

    {% else %}
        {{ prescription.get_status_display }}
    {% endif %}
                                </span>
                                                                </td>
                                                                <td>
                                                                    <span>{{ prescription.created_by.user.get_full_name }}</span>
                                                                </td>
                                                                <td> 
                                                                    {% if prescription.status == "Pending" %}
                                                                    <form method="post" action="{% url 'delete_prescription' prescription.id %}" style="display:inline;">
        {% csrf_token %}
        <button type="submit" class="btn btn-danger btn-icon btn-round btn-xs" onclick="return confirm('Voulez-vous vraiment supprimer cette prescription ?')">
            <em class="icon ni ni-trash-fill"></em>
        </button>
    </form>
                                                                    {% endif %}
                                                                   <form method="post" action="{% url 'stop_traitement' prescription.id %}" style="display:inline;">
                                                                       
    {% csrf_token %}
    <button type="button" class="btn btn-primary btn-icon btn-round btn-xs ml-2"
            onclick="askCancellationReason(event, this)">
        <em class="icon ni ni-stop-fill"></em>
    </button>
    <input type="hidden" name="cancellation_reason" id="cancellation_reason_{{ prescription.id }}">
</form>

<script>
function askCancellationReason(event, button) {
    event.preventDefault();  // Empêche la soumission automatique du formulaire

    let reason = prompt("Veuillez entrer un motif pour l'annulation de cette prescription :");

    if (reason !== null && reason.trim() !== "") {
        let form = button.closest("form");  // Trouve le formulaire parent
        let inputField = form.querySelector("[name='cancellation_reason']");
        inputField.value = reason;
        form.submit();  // Soumet le formulaire avec la raison
    } else {
        alert("L'annulation a été annulée car aucun motif n'a été fourni.");
    }
}
</script>
                                                                </td>
                                                            </tr>
                                                        {% endfor %}
                                                    {% else %}
                                                        <tr>
                                                            <td colspan="4" style="font-style: italic; text-align: center" class="text-white">
                                                                Aucune donnée enregistrée
                                                            </td>
                                                        </tr>
                                                    {% endif %}
                                                    </tbody>
                                                </table>
                                                <!-- Bouton pour afficher plus ou moins de données -->
                                                {% if prescriptions|length > 5 %}
                                                    <div class="text-center mt-3">
                                                        <button id="toggleButtonPrescriptions" class="btn btn-secondary">Voir plus
                                                        </button>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>


                                    <!-- JavaScript pour le tableau des prescriptions -->
                                    <script>
                                        document.addEventListener('DOMContentLoaded', function () {
                                            const toggleButtonPrescriptions = document.getElementById('toggleButtonPrescriptions');
                                            const prescriptionDataRows = document.querySelectorAll('.prescription-data');
                                            let isExpandedPrescriptions = false;

                                            toggleButtonPrescriptions.addEventListener('click', function () {
                                                if (isExpandedPrescriptions) {
                                                    prescriptionDataRows.forEach(row => row.classList.add('d-none'));
                                                    toggleButtonPrescriptions.textContent = 'Voir plus';
                                                } else {
                                                    prescriptionDataRows.forEach(row => row.classList.remove('d-none'));
                                                    toggleButtonPrescriptions.textContent = 'Voir moins';
                                                }
                                                isExpandedPrescriptions = !isExpandedPrescriptions;
                                            });
                                        });
                                    </script>

                                    <!-- Prescriptions Form Modal -->
{#                                    <div class="modal fade" id="prescriptionModal" tabindex="-1" aria-labelledby="prescriptionModalLabel" aria-hidden="true">#}
{#                                        <div class="modal-dialog modal-lg">#}
{#                                            <div class="modal-content">#}
{#                                                <div class="modal-header">#}
{#                                                    <h5 class="modal-title" id="prescriptionModalLabel">Nouvelles Prescription</h5>#}
{#                                                    <button type="button" class="btn btn-close" data-bs-dismiss="modal" aria-label="Close">X</button>#}
{#                                                </div>#}
{#                                                <div class="modal-body">#}
{#                                                    <div class="row">#}
{#                                                        <form method="post" id="form-prescription" action="{% url 'hospitalisationdetails' hospitalisationdetail.id %}">#}
{#                                                            {% csrf_token %}#}
{#                                                          #}
{#                                                            <div class="row">#}
{#                                                                {% for field in prescription_hospi_form %}#}
{#                                                                    <div class="col-md-3 mb-3">#}
{#                                                                        <div class="form-group">#}
{#                                                                            <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }}</label>#}
{#                                                                            <div class="form-control-wrap">#}
{#                                                                                {{ field }}#}
{#                                                                            </div>#}
{#                                                                        </div>#}
{#                                                                    </div>#}
{#                                                                {% endfor %}#}
{#                                                            </div>#}
{#                                                            <button type="submit" class="btn btn-primary float-right">Enregistrer</button>#}
{#                                                        </form>#}
{#                                                    </div>#}
{##}
{#                                                </div>#}
{#                                            </div>#}
{#                                        </div>#}
{#                                    </div>#}
                                <div class="modal fade" id="prescriptionModal" tabindex="-1" aria-labelledby="prescriptionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="prescriptionModalLabel">Nouvelle Prescription</h5>
                <button type="button" class="btn btn-close" data-bs-dismiss="modal" aria-label="Close">X</button>
            </div>
            <div class="modal-body">

                <div x-data="prescriptionForm()" class="row">
                    <div x-show="errorMessage" class="alert alert-danger">
    <span x-text="errorMessage"></span>
</div>
                    <form method="post" id="form-prescription" x-on:submit.prevent="submitForm">
                        {% csrf_token %}
    <input type="hidden" name="patient_id" x-model="patientId">  <!-- ✅ Ajout du patient ID -->
    <input type="hidden" name="hospitalisation_id" x-model="hospitalisationId">  <!-- ✅ Ajout de l'hospitalisation ID -->
                        <div class="row">
                            <!-- Champ de recherche dynamique pour le médicament -->
                            <div class="col-md-8 mb-3">
                                <label class="form-label">Médicament</label>
                                <input type="text" class="form-control" x-model="search" x-on:input="fetchMedications()"
                                    placeholder="Ex: Nivaquine comprime 500 mg"
                                    autocomplete="off"
                                    required />
                                <!-- Liste des suggestions -->
                                <ul x-show="results.length > 0" class="list-group mt-2">
                                    <template x-for="med in results" :key="med.id">
                                        <li class="list-group-item list-group-item-action" x-text="`${med.nom} ${(med.dosage_form ? med.dosage_form : '')} ${(med.dosage ? med.dosage : '')} ${(med.unitdosage ? med.unitdosage : '')}`.trim()" x-on:click="selectMedication(med)">
                                        </li>
                                    </template>
                                </ul>
                            </div>

                            <!-- Quantité -->
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Quantité</label>
                                <input type="number" class="form-control" name="quantity" placeholder="Entrez la quantité" required />
                            </div>

                            <!-- Posologie -->
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Posologie</label>
                                <select class="form-control" name="posology" required>
                                    <option value="">Sélectionnez la posologie</option>
                                    <option value="Une fois par jour">Une fois par jour</option>
                                    <option value="Deux fois par jour">Deux fois par jour</option>
                                    <option value="Trois fois par jour">Trois fois par jour</option>
                                    <option value="Quatre fois par jour">Quatre fois par jour</option>
                                    <option value="Toutes les 4 heures">Toutes les 4 heures</option>
                                    <option value="Toutes les 6 heures">Toutes les 6 heures</option>
                                    <option value="Toutes les 8 heures">Toutes les 8 heures</option>
                                    <option value="Si besoin">Si besoin</option>
                                    <option value="Avant les repas">Avant les repas</option>
                                    <option value="Après les repas">Après les repas</option>
                                    <option value="Au coucher">Au coucher</option>
                                    <option value="Une fois par semaine">Une fois par semaine</option>
                                    <option value="Deux fois par semaine">Deux fois par semaine</option>
                                    <option value="Un jour sur deux">Un jour sur deux</option>,
                                </select>
                            </div>

                            <!-- Pendant -->
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Pendant</label>
                                <select class="form-control" name="pendant">
                                    <option value="">Sélectionnez</option>
                                    <option value="1">1 jours</option>
                                    <option value="2">2 jours</option>
                                    <option value="3">3 jours</option>
                                    <option value="4">4 jours</option>
                                    <option value="5">5 jours</option>
                                    <option value="6">6 jours</option>
                                    <option value="7">7 jours</option>
                                    <option value="8">8 jours</option>
                                    <option value="9">9 jours</option>
                                    <option value="10">10 jours</option>
                                    <option value="14">14 jours</option>
                                    <option value="21">21 jours</option>
                                    <option value="30">30 jours</option>
                                </select>
                            </div>

                            <!-- À partir de -->
                            <div class="col-md-4 mb-3">
                                <label class="form-label">À partir de</label>
                                <select class="form-control" name="a_partir_de">
                                    <option value="">Sélectionnez</option>
                                    <option value="0">Maintenant</option>
                                    <option value="1">dans 1 heure</option>
                                    <option value="2">dans 2 heures</option>
                                    <option value="3">dans 3 heures</option>
                                    <option value="4">dans 4 heures</option>
                                    <option value="5">dans 5 heures</option>
                                    <option value="6">dans 6 heures</option>
                                    <option value="7">dans 7 heures</option>
                                    <option value="8">dans 8 heures</option>
                                    <option value="12">dans 12 heures</option>
                                    <option value="24">dans 24 heures</option>
                                    <option value="48">dans 48 heures</option>
                                    <option value="72">dans 72 heures</option>
                                </select>
                            </div>
                        </div>

                        <!-- Champ caché pour indiquer si c'est un nouveau médicament -->
                        <input type="hidden" name="is_new_medication" x-model="isNewMedication">
                        <button type="submit" class="btn btn-success float-right">Enregistrer</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
                                </div>
                            </div>
                                <!-- Indicateurs Biologiques -->
                                <div class="row m-4">

                                    <h3 class="text-muted"> Indicateurs Biologiques </h3>

                                    <div class="row col-12">
                                        <!-- Indicateur Biologique Card -->
                                        <div class="col-12 col-md-12 mb-5">
                                        <div id="biological-chart"></div>
                                        <div id="indicators-chart"></div>
                                            <div class="card text-black-100 border">
                                                <div class="card-header">
                                                    Indicateurs Biologiques
                                                    {% if not hospitalisationdetail.discharge_date %}
                                                    <button type="button" class="btn btn-dark btn-icon btn-round float-right" data-toggle="modal" data-target="#indicateurbiologiqueformModal">
                                                        <em class="icon ni ni-plus-circle-fill"></em>
                                                    </button>
                                                    {% endif %}
                                                </div>
                                                <div class="card-inner text-black-70">
                                                    <table class="table">
                                                        <thead>
                                                        <tr>
                                                            <th>Indicateurs</th>
                                                            <th>Date</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                        </thead>
                                                        <tbody>
                                                        {% if indicateur_biologique %}
                                                            {% for indicateur in indicateur_biologique %}
                                                                <tr>
                                                                    <td>
                                                                        <span class="badge badge-dark">Globules Blancs: {{ indicateur.globules_blancs }}</span><br>
                                                                        <span class="badge badge-dark">Hémoglobine: {{ indicateur.hemoglobine }}</span>
                                                                    </td>
                                                                    <td>{{ indicateur.date|date:"d/m/Y" }}</td>
                                                                    <td>
                                    <span>
                                        <a href="#" class="btn btn-primary btn-icon btn-round btn-xs"><em
                                                class="icon ni ni-eye"></em></a>
                                        <a href="#" class="btn btn-danger btn-icon btn-round btn-xs"><em
                                                class="icon ni ni-trash-fill"></em></a>
                                    </span>
                                                                    </td>
                                                                </tr>
                                                            {% endfor %}
                                                        {% else %}
                                                            <tr>
                                                                <td colspan="3" style="font-style: italic; text-align: center" class="text-white">
                                                                    Aucune donnée enregistrée
                                                                </td>
                                                            </tr>
                                                        {% endif %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                     <!-- Indicateur Form Modal -->
                                    <div class="modal fade" id="indicateurbiologiqueformModal" tabindex="-1" aria-labelledby="indicateurbiologiqueformModalModalLabel" aria-hidden="true">
                                        <div class="modal-dialog modal-lg">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="indicateurbiologiqueformModalLabel">Indicateurs biologique</h5>
                                                    <button type="button" class="btn btn-close" data-bs-dismiss="modal" aria-label="Close">X</button>
                                                </div>
                                                <div class="modal-body">
                                                    <div class="row">
                                                        <form method="post" action="{% url 'hospitalisationdetails' hospitalisationdetail.id %}">
                                                            {% csrf_token %}
                                                            <div class="row">
                                                                {% for field in indicateur_biologique_form %}
                                                                    <div class="col-md-6 mb-3">
                                                                        <div class="form-group">
                                                                            <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
                                                                            <div class="form-control-wrap">
                                                                                {{ field }}
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                {% endfor %}
                                                            </div>
                                                            <button type="submit" class="btn btn-primary float-right">Enregistrer</button>
                                                        </form>
                                                    </div>

                                                </div>
                                            </div>
                                        </div>
                                    </div>


                                    </div>


                                </div>
                            <!-- Indicateurs  Fonctionnels  -->
                                <div class="row m-4">

                                    <h3 class="text-muted"> Indicateurs Fonctionnels </h3>

                                    <div class="row col-12">
                                        <!-- Signe Fonctionnel Card -->
                                        <!-- Indicateur Fonctionnel Card -->
                                    <div class="col-12 col-md-12 mb-5"><div id="functional-chart"></div></div>

                                        <div class="col-12 col-md-12 mb-5">
                                            <div class="card text-black-100 border">
                                                <div class="card-header">
                                                    Indicateurs Fonctionnels
                                                    {% if not hospitalisationdetail.discharge_date %}
                                                    <button type="button"
                                                            class="btn btn-dark btn-icon btn-round float-right"
                                                            data-toggle="modal"
                                                            data-target="#indicateurFonctionnelModal">
                                                        <em class="icon ni ni-plus-circle-fill"></em>
                                                    </button>
                                                    {% endif %}
                                                </div>
                                                <div class="card-inner text-black-70">
                                                    <table class="table">
                                                        <thead>
                                                        <tr>
                                                            <th>Indicateurs</th>
                                                            <th>Date</th>
                                                            <th>Medecin</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                        </thead>
                                                        <tbody>
                                                        {% if indicateur_fonctionnel %}
                                                            {% for indicateur in indicateur_fonctionnel %}
                                                                <tr>
                                                                    <td>
                                                                        <span class="badge badge-dark">Mobilité: {{ indicateur.mobilite }}</span><br>
                                                                        <span class="badge badge-dark">Conscience: {{ indicateur.conscience }}</span><br>
                                                                        <span class="badge badge-dark">Débit urinaire: {{ indicateur.debit_urinaire }} L</span>
                                                                    </td>
                                                                    <td>{{ indicateur.date|date:"d/m/Y" }}</td>
                                                                     <td>{{ indicateur.patient}}</td>
                                                                    <td>
                                    <span>
                                        <a href="#" class="btn btn-primary btn-icon btn-round btn-xs"><em
                                                class="icon ni ni-eye"></em></a>
                                        <a href="#" class="btn btn-danger btn-icon btn-round btn-xs"><em
                                                class="icon ni ni-trash-fill"></em></a>
                                    </span>
                                                                    </td>
                                                                </tr>
                                                            {% endfor %}
                                                        {% else %}
                                                            <tr>
                                                                <td colspan="3"
                                                                    style="font-style: italic; text-align: center"
                                                                    class="text-white">
                                                                    Aucune donnée enregistrée
                                                                </td>
                                                            </tr>
                                                        {% endif %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                      <!-- Indicateur Fonctionnel Modal -->
                                    <div class="modal fade" id="indicateurFonctionnelModal" tabindex="-1"
                                         aria-labelledby="indicateurFonctionnelModalLabel" aria-hidden="true">
                                        <div class="modal-dialog modal-lg">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="indicateurFonctionnelModalLabel">Indicateurs Fonctionnels </h5>
                                                    <button type="button" class="btn btn-close" data-bs-dismiss="modal" aria-label="Close">X</button>
                                                </div>
                                                <div class="modal-body">
                                                    <div class="row">
                                                        <form method="post" action="{% url 'hospitalisationdetails' hospitalisationdetail.id %}">
                                                            {% csrf_token %}
                                                            <div class="row">
                                                                {% for field in indicateur_fonctionnel_form %}
                                                                    <div class="col-md-6 mb-3">
                                                                        <div class="form-group">
                                                                            <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
                                                                            <div class="form-control-wrap">
                                                                                {{ field }}
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                {% endfor %}
                                                            </div>
                                                            <button type="submit" class="btn btn-primary float-right">Enregistrer</button>
                                                        </form>
                                                    </div>

                                                </div>
                                            </div>
                                        </div>
                                    </div>




                                    </div>


                                </div>



                            <!-- Indicateurs  de Complications & de Traitement  -->

                            <div class="row m-4">

                                <h3 class="text-muted"> Indicateurs de Complications & de Traitement  </h3>


                                <div class="row col-12">
                                     <div class="col-12">
                                <div id="complications-chart"></div>
                            </div>
                                    <div class="col-3 col-md-3 mb-5">
                                        <div id="mental-state-chart"></div>
                                    </div>
                                    <div class="col-3 col-md-3 mb-5">
                                        <div id="electrolytes-balance-chart"></div>
                                    </div>

                                    <div class="col-3 col-md-3 mb-5">
                                        <div id="renal-function-chart"></div>
                                    </div>
                                    <div class="col-3 col-md-3 mb-5">
                                        <div id="hepatic-function-chart"></div>
                                    </div>
                                </div>
                                    <div class="col-12 col-md-12 mb-5">
                                        <div class="card text-black-100 border">
                                            <div class="card-header">
                                                Indicateurs Autres
                                                {% if not hospitalisationdetail.discharge_date %}
                                                <button type="button"
                                                        class="btn btn-dark btn-icon btn-round float-right"
                                                        data-toggle="modal" data-target="#indicateurautresModal">
                                                    <em class="icon ni ni-plus-circle-fill"></em>
                                                </button>
                                                {% endif %}
                                            </div>
                                            <div class="card-inner text-black-70">
                                                <h2 class="mb-4">Liste des Indicateurs d'Hospitalisation</h2>
                                                <table class="table table-bordered table-responsive">
                                                    <thead>
                                                    <tr>
                                                        <th>Niveau de Douleur</th>
                                                        <th>État de Conscience</th>
                                                        <th>Réponse au Traitement</th>
                                                        <th>Effets Secondaires</th>
                                                        <th>Observance</th>
                                                        <th>Équilibre Électrolytique</th>
                                                        <th>Fonction Rénale</th>
                                                        <th>Fonction Hépatique</th>
                                                        <th>Signes Vitaux Stables</th>
                                                        <th>Douleur Contrôlée</th>
                                                        <th>Capacité Fonctionnelle</th>
                                                        <th>État Mental Stable</th>
                                                        <th>Plan de Suivi</th>
                                                        <th>Date de Création</th>
                                                    </tr>
                                                    </thead>
                                                    <tbody>
                                                    {% for indicator in indicators %}
                                                        <tr>
                                                            <td>{{ indicator.pain_level }}</td>
                                                            <td>{{ indicator.get_mental_state_display }}</td>
                                                            <td>{{ indicator.treatment_response }}</td>
                                                            <td>{{ indicator.side_effects }}</td>
                                                            <td>{{ indicator.compliance|yesno:"Oui,Non" }}</td>
                                                            <td>{{ indicator.electrolytes_balance }}</td>
                                                            <td>{{ indicator.renal_function }}</td>
                                                            <td>{{ indicator.hepatic_function }}</td>
                                                            <td>{{ indicator.stable_vitals|yesno:"Oui,Non" }}</td>
                                                            <td>{{ indicator.pain_controlled|yesno:"Oui,Non" }}</td>
                                                            <td>{{ indicator.functional_ability|yesno:"Oui,Non" }}</td>
                                                            <td>{{ indicator.mental_stability|yesno:"Oui,Non" }}</td>
                                                            <td>{{ indicator.follow_up_plan }}</td>
                                                            <td>{{ indicator.created_at|date:"d/m/Y H:i" }}</td>
                                                        </tr>
                                                    {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>


                            </div>

                        <div class="modal fade" id="indicateurautresModal" tabindex="-1" aria-labelledby="indicateurautresModalLabel" aria-hidden="true">
                                        <div class="modal-dialog modal-lg">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="indicateurautresModalLabel">Indicateurs autres</h5>
                                                    <button type="button" class="btn btn-close" data-bs-dismiss="modal" aria-label="Close">X</button>
                                                </div>
                                                <div class="modal-body">
                                                    <div class="row">
                                                        <form method="post" action="{% url 'hospitalisationdetails' hospitalisationdetail.id %}">
                                                            {% csrf_token %}
                                                            <div class="row">
                                                                {% for field in autresindicatorsform %}
                                                                    <div class="col-md-6 mb-3">
                                                                        <div class="form-group">
                                                                            <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
                                                                            <div class="form-control-wrap">{{ field }}</div>
                                                                        </div>
                                                                    </div>
                                                                {% endfor %}
                                                            </div>
                                                            <button type="submit" class="btn btn-primary float-right">Enregistrer</button>
                                                        </form>
                                                    </div>

                                                </div>
                                            </div>
                                        </div>
                                    </div><!-- Indicateurs  de Traitement  -->

                            <!-- Indicateurs  de Sortie  -->
                            <div class="row m-4">

                                <h3 class="text-muted"> Indicateurs de Sortie (Critères de décharge) </h3>

                                <div class="row col-12">
                                    <div class="col-12 col-md-12 mb-5">
                                        <div class="card text-black-100 border">
                                            <div class="card-header">
                                                Indicateurs de Sortie - Aide à la Décision
                                            </div>
                                            <div class="card-inner text-black-70">

                                                <div id="dischargeChart"></div>
                                            </div>
                                        </div>
                                    </div>


                                </div>


                            </div>
                        </div>
                    <!-- .card-inner-group -->
                    </div><!-- .card -->
                </div>
            </div>
    </div>
{#   <script>#}
{#    $(document).ready(function () {#}
{#        $('#medication').select2({#}
{#            tags: true,#}
{#            tokenSeparators: [',', ' '],#}
{#            placeholder: "Choisissez ou ajoutez un médicament",#}
{#            allowClear: true,#}
{#            ajax: {#}
{#                url: "{% url 'add_medicament' %}",#}
{#                type: "POST",#}
{#                dataType: "json",#}
{#                delay: 250,#}
{#                data: function (params) {#}
{#                    return {#}
{#                        nom: params.term, // Nom du médicament saisi#}
{#                        csrfmiddlewaretoken: '{{ csrf_token }}' // Sécurisation CSRF#}
{#                    };#}
{#                },#}
{#                processResults: function (data) {#}
{#                    if (data.success) {#}
{#                        return {#}
{#                            results: [{ id: data.id, text: data.nom }]#}
{#                        };#}
{#                    } else {#}
{#                        alert(data.message);#}
{#                        return { results: [] };#}
{#                    }#}
{#                },#}
{#                error: function (xhr, status, error) {#}
{#                    console.error("Erreur AJAX:", status, error);#}
{#                    alert("Une erreur est survenue lors de la récupération des médicaments.");#}
{#                }#}
{#            },#}
{#            createTag: function (params) {#}
{#                let term = $.trim(params.term);#}
{#                if (term === '') {#}
{#                    return null;#}
{#                }#}
{#                return {#}
{#                    id: term,#}
{#                    text: term,#}
{#                    newTag: true#}
{#                };#}
{#            },#}
{#            multiple: true#}
{#        });#}
{#    });#}
{#</script>#}
<script>
function prescriptionForm() {
    return {
        search: '',
        results: [],
        selectedMedication: null,
        isNewMedication: false,
        errorMessage: '',
        patientId: "{{ hospitalisationdetail.patient.id }}",  
        hospitalisationId: "{{ hospitalisationdetail.id }}",  


        fetchMedications() {
            if (this.search.length < 2) {
                this.results = [];
                return;
            }

            fetch(`/api/medicaments/?q=${this.search}`)
                .then(response => response.json())
                .then(data => {
                    this.results = data;
                    this.isNewMedication = this.results.length === 0;
                })
                .catch(error => console.error('❌ Erreur de récupération des médicaments:', error));
        },

        selectMedication(med) {
            this.search = `${med.nom} ${(med.dosage_form ? med.dosage_form : '')} ${(med.dosage ? med.dosage : '')} ${(med.unitdosage ? med.unitdosage : '')}`.trim();
            this.selectedMedication = med;
            this.isNewMedication = false;
            this.results = [];
        },

        submitForm() {
            this.errorMessage = '';

            let formData = new FormData(document.getElementById('form-prescription'));

            // ✅ Ajout du patient ID
            formData.append('patient_id', this.patientId);
            formData.append('hospitalisation_id', this.hospitalisationId);
            formData.append('medication', this.search);
            formData.append('is_new_medication', this.isNewMedication);

            fetch('/api/prescription/add/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("✅ Prescription enregistrée !");
                    window.location.reload();
                } else {
                    console.error("❌ Erreur lors de l'enregistrement:", data.error);
                    this.errorMessage = "⚠️ " + data.error;
                }
            })
            .catch(error => {
                console.error('❌ Erreur AJAX:', error);
                this.errorMessage = "Erreur réseau. Vérifiez votre connexion.";
            });
        }
    };
}
</script>
    <script>
        $(document).ready(function () {
            // Initialisation de Select2 avec l'option tags
            $('.select2').select2({
                tags: true,
                tokenSeparators: [',', ' '],
                placeholder: "Choisissez ou ajoutez une maladie",
                allowClear: true,
                ajax: {
                    url: "{% url 'add_maladie' %}",
                    type: "POST",
                    dataType: "json",
                    delay: 250,
                    data: function (params) {
                        return {
                            nom: params.term, // Le terme recherché ou ajouté
                            csrfmiddlewaretoken: '{{ csrf_token }}' // Token CSRF pour sécuriser la requête
                        };
                    },
                    processResults: function (data) {
                        if (data.success) {
                            return {
                                results: [
                                    {id: data.id, text: data.nom}
                                ]
                            };
                        } else {
                            alert(data.message);
                            return {results: []};
                        }
                    },
                },
            });
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Reinitialiser TinyMCE quand le modal est affiché
            $('#adddiagnosticModal').on('shown.bs.modal', function () {
                tinymce.remove(); // Supprimer les anciennes instances (si rechargé)
                tinymce.init({
                    selector: '.tinymce-basic',
                    plugins: 'advlist autolink lists link charmap print preview anchor',
                    toolbar: 'bold italic underline | alignleft aligncenter alignright | bullist numlist outdent indent',
                    menubar: false,
                    height: 300,
                });
            });
        });
    </script>

    <script>
        // Données JSON pour les indicateurs et leurs plages
        const chartData = JSON.parse('{{ lab_ink|escapejs }}');

        // Extraire les valeurs pour la configuration des séries de données
        const categories = chartData.indicators.map(indicator => indicator.name);
        const seriesData = [
            {
                name: "Plage Normale",
                data: chartData.indicators.map(indicator => indicator.normal_part)
            },
            {
                name: "Valeur dans la Plage Normale",
                data: chartData.indicators.map(indicator => indicator.within_range)
            },
            {
                name: "Valeur Excédentaire/Déficitaire",
                data: chartData.indicators.map(indicator => indicator.additional_part)
            }
        ];

        // Configuration du graphique ApexCharts
        const options = {
            chart: {
                type: 'bar',
                height: 700,
                stacked: true,
            },
            series: seriesData,
            colors: ['#00E396', '#4CAF50', '#FF4560'], // Vert pour la plage normale, vert foncé pour la valeur dans la plage, rouge pour valeur hors norme
            plotOptions: {
                bar: {
                    horizontal: true,
                    barHeight: '80%',
                    dataLabels: {
                        position: 'top'
                    },
                }
            },
            dataLabels: {
                enabled: true,
                formatter: function (val, opts) {
                    const indicator = chartData.indicators[opts.dataPointIndex];
                    if (opts.seriesIndex === 2) {
                        return indicator.additional_part ? `Excès: ${indicator.additional_part}` : '';
                    } else if (opts.seriesIndex === 1) {
                        return indicator.actual !== null ? `Actuel: ${indicator.actual}` : 'N/A';
                    }
                    return '';
                },
                offsetX: -6,
                style: {
                    fontSize: '12px',
                    colors: ['#304758']
                }
            },
            xaxis: {
                categories: categories,
                title: {
                    text: 'Valeurs'
                }
            },
            title: {
                text: 'Indicateurs de Complications et Seuils de Danger',
                align: 'center'
            },
            tooltip: {
                shared: true,
                intersect: false,
                y: {
                    formatter: function (val, opts) {
                        const indicator = chartData.indicators[opts.dataPointIndex];
                        if (opts.seriesIndex === 2) {
                            return `Excédent ou déficit: ${indicator.additional_part}`;
                        }
                        return `Actuel: ${indicator.actual}`;
                    }
                }
            },
            legend: {
                position: 'top',
                horizontalAlign: 'left'
            }
        };

        // Rendu du graphique
        const chart = new ApexCharts(document.querySelector("#indicators-chart"), options);
        chart.render();
    </script>
    <script>
        // Données JSON pour le graphique des indicateurs fonctionnels
        const functionalData = JSON.parse('{{ functional_chart_data|escapejs }}');

        // Transformation des données qualitatives en valeurs numériques pour le graphique
        const mobilityValues = functionalData.mobilite.map(mobility => {
            if (mobility === "indépendant") return 3;
            if (mobility === "assisté") return 2;
            if (mobility === "immobile") return 1;
            return null;
        });

        const consciousnessValues = functionalData.conscience.map(consciousness => {
            if (consciousness === "alerte") return 3;
            if (consciousness === "somnolent") return 2;
            if (consciousness === "inconscient") return 1;
            return null;
        });

        // Configuration du graphique ApexCharts
        const functionalOptions = {
            chart: {
                type: 'bar',
                height: 450
            },
            series: [
                {
                    name: 'Mobilité',
                    data: mobilityValues
                },
                {
                    name: 'Conscience',
                    data: consciousnessValues
                },
                {
                    name: 'Débit Urinaire (L)',
                    data: functionalData.debit_urinaire
                }
            ],
            xaxis: {
                categories: functionalData.dates,
                title: {
                    text: 'Dates'
                },
                labels: {
                    rotate: -45
                }
            },
            yaxis: [
                {
                    title: {
                        text: 'Niveau Mobilité et Conscience'
                    },
                    min: 0,
                    max: 3,
                    tickAmount: 3,
                    labels: {
                        formatter: function (value) {
                            if (value === 3) return 'Indépendant / Alerte';
                            if (value === 2) return 'Assisté / Somnolent';
                            if (value === 1) return 'Immobile / Inconscient';
                            return '';
                        }
                    }
                },
                {
                    opposite: true,
                    title: {
                        text: 'Débit Urinaire (L)'
                    },
                    min: 0
                }
            ],
            tooltip: {
                shared: true,
                intersect: false,
            },
            title: {
                text: 'Évolution des Indicateurs Fonctionnels',
                align: 'center'
            }
        };

        // Rendu du graphique
        const functionalChart = new ApexCharts(document.querySelector("#functional-chart"), functionalOptions);
        functionalChart.render();
    </script>
    <script>
        // Données JSON pour les indicateurs de complications
        const complicationsData = JSON.parse('{{ complications_chart_data|escapejs }}');

        // Transformation de l'état mental en valeurs numériques
        const mentalStateValues = complicationsData.mental_state.map(state => {
            if (state === "clair") return 3;
            if (state === "confusion") return 2;
            if (state === "somnolent") return 1;
            return null;
        });

        // Configuration du graphique ApexCharts
        const complicationsOptions = {
            chart: {
                type: 'line',
                height: 450
            },
            series: [
                {
                    name: 'Niveau de Douleur',
                    data: complicationsData.pain_level
                },
                {
                    name: 'État Mental',
                    data: mentalStateValues
                }
            ],
            xaxis: {
                categories: complicationsData.dates,
                title: {
                    text: 'Dates'
                },
                labels: {
                    rotate: -45
                }
            },
            yaxis: [
                {
                    title: {
                        text: 'Niveau de Douleur'
                    },
                    min: 0,
                    max: 10,
                    tickAmount: 10
                },
                {
                    opposite: true,
                    title: {
                        text: 'État Mental'
                    },
                    min: 0,
                    max: 3,
                    tickAmount: 3,
                    labels: {
                        formatter: function (value) {
                            if (value === 3) return 'Clair';
                            if (value === 2) return 'Confusion';
                            if (value === 1) return 'Somnolent';
                            return '';
                        }
                    }
                }
            ],
            tooltip: {
                shared: true,
                intersect: false,
            },
            title: {
                text: 'Évolution des Indicateurs de Complications',
                align: 'center'
            }
        };

        // Rendu du graphique
        const complicationsChart = new ApexCharts(document.querySelector("#complications-chart"), complicationsOptions);
        complicationsChart.render();
    </script>
    <script>
        // Données JSON pour les graphiques en camembert
        const pieChartData = JSON.parse('{{ pie_chart_data|escapejs }}');

        // Fonction de configuration et de rendu d'un graphique en camembert
        function renderPieChart(elementId, seriesData, labels, title) {
            const options = {
                chart: {
                    type: 'donut',
                    height: 350
                },
                series: seriesData,
                labels: labels,
                title: {
                    text: title,
                    align: 'center'
                }
            };

            const chart = new ApexCharts(document.querySelector(elementId), options);
            chart.render();
        }

        // Données et rendu du graphique pour l'état mental
        const mentalStateLabels = Object.keys(pieChartData.mental_state);
        const mentalStateSeries = Object.values(pieChartData.mental_state);
        renderPieChart("#mental-state-chart", mentalStateSeries, mentalStateLabels, "État Mental");

        // Données et rendu du graphique pour l'équilibre électrolytique
        const electrolytesBalanceLabels = Object.keys(pieChartData.electrolytes_balance);
        const electrolytesBalanceSeries = Object.values(pieChartData.electrolytes_balance);
        renderPieChart("#electrolytes-balance-chart", electrolytesBalanceSeries, electrolytesBalanceLabels, "Équilibre Électrolytique");

        // Données et rendu du graphique pour la fonction rénale
        const renalFunctionLabels = Object.keys(pieChartData.renal_function);
        const renalFunctionSeries = Object.values(pieChartData.renal_function);
        renderPieChart("#renal-function-chart", renalFunctionSeries, renalFunctionLabels, "Fonction Rénale");

        // Données et rendu du graphique pour la fonction hépatique
        const hepaticFunctionLabels = Object.keys(pieChartData.hepatic_function);
        const hepaticFunctionSeries = Object.values(pieChartData.hepatic_function);
        renderPieChart("#hepatic-function-chart", hepaticFunctionSeries, hepaticFunctionLabels, "Fonction Hépatique");
    </script>
    <script>
        // Données JSON pour le graphique des indicateurs biologiques
        const biologicalData = JSON.parse('{{ chart_data|escapejs }}');

        // Configuration du graphique des indicateurs biologiques
        const biologicalOptions = {
            chart: {
                type: 'area',
                height: 450
            },
            series: [
                {
                    name: 'Globules blancs',
                    data: biologicalData.globules_blancs
                },
                {
                    name: 'Hémoglobine',
                    data: biologicalData.hemoglobine
                },
                {
                    name: 'Plaquettes',
                    data: biologicalData.plaquettes
                },
                {
                    name: 'CRP',
                    data: biologicalData.crp
                },
                {
                    name: 'Glucose sanguin',
                    data: biologicalData.glucose_sanguin
                }
            ],
            xaxis: {
                categories: biologicalData.dates,
                title: {
                    text: 'Dates'
                },
                labels: {
                    rotate: -45
                }
            },
            yaxis: {
                title: {
                    text: 'Valeurs'
                }
            },
            tooltip: {
                shared: true,
                intersect: false,
            },
            title: {
                text: 'Évolution des Indicateurs Biologiques',
                align: 'center'
            }
        };

        // Initialisation du graphique des indicateurs biologiques
        const biologicalChart = new ApexCharts(document.querySelector("#biological-chart"), biologicalOptions);
        biologicalChart.render();
    </script>
    <script>
        // Données JSON pour le graphique des constantes vitales
        const labels = [
            {% for constante in constantes %}
                "{{ constante.created_at|date:'Y-m-d H:i' }}",
            {% endfor %}
        ];

        const temperatureData = [
            {% for constante in constantes %}
                {{ constante.temperature|default:"null" }},
            {% endfor %}
        ];

        const heartRateData = [
            {% for constante in constantes %}
                {{ constante.frequence_cardiaque|default:"null" }},
            {% endfor %}
        ];

        const respiratoryRateData = [
            {% for constante in constantes %}
                {{ constante.frequence_respiratoire|default:"null" }},
            {% endfor %}
        ];

        const oxygenSaturationData = [
            {% for constante in constantes %}
                {{ constante.saturation_oxygene|default:"null" }},
            {% endfor %}
        ];

        // Configuration du graphique des constantes vitales
        const constantesOptions = {
            chart: {
                type: 'line',
                height: 350,
                zoom: {
                    enabled: true
                }
            },
            series: [
                {
                    name: 'Température (°C)',
                    data: temperatureData
                },
                {
                    name: 'Fréquence Cardiaque (bpm)',
                    data: heartRateData
                },
                {
                    name: 'Fréquence Respiratoire (rpm)',
                    data: respiratoryRateData
                },
                {
                    name: 'Saturation en Oxygène (%)',
                    data: oxygenSaturationData
                }
            ],
            xaxis: {
                categories: labels,
                title: {
                    text: 'Date et Heure'
                },
                type: 'datetime'
            },
            yaxis: {
                title: {
                    text: 'Valeurs des Constantes Vitales'
                },
                min: 0
            },
            title: {
                text: 'Évolution des Constantes Vitales du Patient',
                align: 'center'
            },
            tooltip: {
                x: {
                    format: 'dd MMM yyyy HH:mm'
                }
            }
        };

        // Initialisation du graphique des constantes vitales
        const constantesChart = new ApexCharts(document.querySelector("#constantesChart"), constantesOptions);
        constantesChart.render();
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            let formIdx = {{ symptomes_forms|length }};
            document.getElementById('add-symptome').addEventListener('click', function () {
                const newForm = document.createElement('div');
                newForm.className = 'row';
                const formHtml = `<div class="col-lg-6 col-sm-12 mb-3">
<div class="form-group">
<label class="form-label" for="id_symptomes-${formIdx}-nom">Nom</label>
<input type="text" name="nom[]" maxlength="255" class="form-control form-control-lg" required id="id_symptomes-${formIdx}-nom">
</div>
                              </div>
                              <div class="col-lg-6 col-sm-12 mb-3">
                                <div class="form-group">
                                    <label class="form-label" for="id_symptomes-${formIdx}-date_debut">Date début</label>
                                    <input type="date" name="date_debut[]" class="form-control form-control-lg" required id="id_symptomes-${formIdx}-date_debut">
                                </div>
                              </div>`;
                newForm.innerHTML = formHtml;
                document.getElementById('symptomes-forms').appendChild(newForm);
                formIdx++;
            });
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const dischargeCriteria = {{ discharge_criteria|safe }};

            const options = {
                chart: {
                    type: 'bar',
                    height: 350
                },
                plotOptions: {
                    bar: {
                        horizontal: true,
                        distributed: true,  // This makes each bar individually colorable
                        colors: {
                            ranges: [
                                {from: 1, to: 1, color: '#4CAF50'}, // Vert pour "Atteint"
                                {from: 0, to: 0, color: '#F44336'}  // Rouge pour "Non Atteint"
                            ]
                        }
                    }
                },
                dataLabels: {
                    enabled: true,
                    formatter: function (val) {
                        return val === 1 ? "Atteint" : "Non Atteint";
                    },
                    style: {
                        colors: ['#000']
                    }
                },
                series: [{
                    name: 'Critère de décharge',
                    data: [
                        dischargeCriteria.stable_vitals || 0,
                        dischargeCriteria.pain_controlled || 0,
                        dischargeCriteria.functional_ability || 0,
                        dischargeCriteria.mental_stability || 0,
                        dischargeCriteria.follow_up_plan || 0
                    ]
                }],
                xaxis: {
                    categories: [
                        "Signes vitaux stables",
                        "Douleur contrôlée",
                        "Capacité fonctionnelle",
                        "État mental stable",
                        "Plan de suivi post-hospitalisation"
                    ]
                },
                tooltip: {
                    enabled: true,
                    y: {
                        formatter: function (val) {
                            return val === 1 ? "Atteint" : "Non Atteint";
                        }
                    }
                }
            };

            const chart = new ApexCharts(document.querySelector("#dischargeChart"), options);
            chart.render();
        });
    </script>
    <script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function () {
        var booleanTypePairs = [
            { checkbox: 'prophylaxie_antiretrovirale', typeField: 'prophylaxie_type' },
            { checkbox: 'traitement_antiretrovirale', typeField: 'traitement_type' },
            { checkbox: 'dernier_regime_antiretrovirale', typeField: 'dernier_regime_antiretrovirale_type' },
            { checkbox: 'traitement_prophylactique_cotrimoxazole', typeField: 'traitement_prophylactique_cotrimoxazole_type' },
        ];

        function toggleTypeField(checkboxId, typeFieldId) {
            var checkbox = document.getElementById(checkboxId);
            var typeField = document.getElementById(typeFieldId);

            if (checkbox && typeField) {
                if (checkbox.checked) {
                    typeField.closest('.form-group').style.display = 'block';
                } else {
                    typeField.closest('.form-group').style.display = 'none';
                }
            }
        }

        booleanTypePairs.forEach(function(pair) {
            toggleTypeField(pair.checkbox, pair.typeField);

            document.getElementById(pair.checkbox).addEventListener('change', function() {
                toggleTypeField(pair.checkbox, pair.typeField);
            });
        });
    });
</script>
    
{% endblock %}