{% extends 'layout/base.html' %}
{% load static %}
{% load humanize %}
{% block content %}
    <style>
    .uniform-btn {
    width: 100%;
    min-width: 100px; /* Définit une largeur minimale pour tous les boutons */
    text-align: left; /* Centre le texte dans les boutons */
    padding: 5px 5px; /* Uniformise le padding des boutons */
    font-size: 16px; /* Assure une taille de texte uniforme */
}
    </style>
    <div class="nk-content nk-content-fluid">

        <div class="container-xl wide-lg">

            <div class="nk-content-body">

                <div class="nk-block-head nk-block-head-sm ">
                    <div class="row rounded" style="height: 200px;background-repeat: no-repeat; background-image: url('{% static 'images/hospitalization.png' %}')">
                        <div class="nk-block-between">
                            <div class="nk-block-head-content">
                                <h1 class="nk-block-title page-title ml-20 sm" style="color: black; text-align: right" > Details Hospitalisation Patient</h1>

                                <div class="nk-block-des">
                                     <a href="{% url 'detail_patient' hospitalisationdetail.patient.pk %}"
                           class=""><h2 class="ml-5"> {{ hospitalisationdetail.patient|upper }}</h2></a>
                                    <h6 class="ml-5">Code Patient: <span class="text-danger">{{ hospitalisationdetail.patient.code_patient }}</span>
                                    <br><a href="{% url 'detail_patient' hospitalisationdetail.patient.pk %}"
                           class="text-white mt-3"><em class="icon ni ni-folder-list"></em> Dossier Medical</a></h6>
{#                                    <h6 class="ml-5">Code VIH: <span class="text-danger">{{ hospitalisationdetail.patient.code_vih }}</span></h6>#}
                                    {% if hospitalisationdetail.discharge_date %}
    <span class="h4 float-right" data-toggle="tooltip" title="{{ hospitalisationdetail.discharge_date }}">
        Patient Sorti {{ hospitalisationdetail.discharge_date|naturaltime }}
    </span>
{% else %}
    <a href="" data-toggle="modal" data-target="#hospitalisationout"
       class="btn btn-outline-warning float-right position-absolute ml-5">
        <i class="fa-solid fa-sign-out "></i> Sortir ?
    </a>
{% endif %}



                                </div>


                            </div><!-- .nk-block-head-content -->

                        </div>

                    </div><!-- .nk-block-between -->

                    <div class="mt-2 " style="height: 20px">

                        {% if observations %}
                            <button class="btn btn-outline-primary " data-toggle="modal"
                                    data-target="#observationsModal">
                                <em class="icon ni ni-eye"></em> Observations<span
                                    class="badge badge-info ml-1">{{ observationscount }}</span>
                            </button>


                        {% endif %}
                        <div class="modal fade" id="observationsModal" tabindex="-1" aria-labelledby="observationsModalLabel" aria-hidden="true">
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="observationsModalLabel">Observations pour l'Hospitalisation</h5>
                                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" aria-label="Close"><em class="icon ni ni-close"></em></button>
                                    </div>
                                    <div class="modal-body">
                                        {% if observations %}
                                            <ul class="list-group">
                                                {% for observation in observations %}
                                                    <li class="list-group-item">
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <div>
                                                                <h6 class="mb-1">
                                                                    <strong>{{ observation.date_enregistrement|naturaltime }}</strong>
                                                                    -
                                                                    <span class="badge badge-info text-dark">{{ observation.statut }}</span>
                                                                </h6>
                                                                <div class="mb-1">{{ observation.details|safe }}</div>
                                                                <small class="text-muted">Enregistré par
                                                                    : {{ observation.medecin.get_full_name|default:"Non spécifié" }}</small>
                                                            </div>
                                                            <div>
                                                                {% if observation.medecin == request.user %}
                                                                    <!-- Button to delete observation -->
                                                                    <form method="post"
                                                                          action=""
                                                                          style="display:inline;">
                                                                        {% csrf_token %}
                                                                        <button type="submit"
                                                                                class="btn btn-danger btn-sm"
                                                                                onclick="return confirm('Voulez-vous vraiment supprimer cette observation ?')">
                                                                            Supprimer
                                                                        </button>
                                                                    </form>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </li>
                                                {% endfor %}
                                            </ul>
                                        {% else %}
                                            <div class="alert alert-info text-center">
                                                Aucune observation enregistrée pour cette hospitalisation.
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {% if historiques_maladie %}
                            <button class="btn btn-outline-primary ml-2" data-toggle="modal"
                                    data-target="#historiqueModal">
                                <em class="icon ni ni-book"></em>Histoire Maladie<span
                                    class="badge badge-info ml-1">{{ effets_indesirablescount }}</span>
                            </button>

                        {% endif %}
                        <!-- Modal Historique -->
                        <div class="modal fade" id="historiqueModal" tabindex="-1"
                             aria-labelledby="historiqueModalLabel" aria-hidden="true">
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="historiqueModalLabel">Historique de la Maladie</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        {% if historiques_maladie %}
                                            <ul class="list-group">
                                                {% for historique in historiques_maladie %}
                                                    <li class="list-group-item">
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <div>
                                                                <h6 class="mb-1">
                                                                    <strong>{{ historique.date_enregistrement|date:"d/m/Y H:i" }}</strong>
                                                                    -
                                                                    <span class="badge bg-info text-dark">Par {{ historique.medecin.get_full_name|default:"Médecin inconnu" }}</span>
                                                                </h6>
                                                                <p class="mb-1">
                                                                    <strong>Description
                                                                        :</strong> {{ historique.description }}
                                                                </p>
                                                                <p class="mb-1">
                                                                    <strong>Antécédents
                                                                        :</strong> {{ historique.antecedents|default:"Non spécifiés" }}
                                                                </p>
                                                                <p class="mb-1">
                                                                    <strong>Diagnostics Associés
                                                                        :</strong> {{ historique.diagnostics_associes|default:"Non spécifiés" }}
                                                                </p>
                                                                <p class="mb-1">
                                                                    <strong>Traitements Précédents
                                                                        :</strong> {{ historique.traitements_precedents|default:"Non spécifiés" }}
                                                                </p>
                                                                <p class="mb-1">
                                                                    <strong>Observations
                                                                        :</strong> {{ historique.observations|default:"Non spécifiées" }}
                                                                </p>
                                                            </div>
                                                            <div>
                                                                {% if historique.medecin == request.user %}
                                                                    <!-- Button to delete historique -->
                                                                    <form method="post" action="" style="display:inline;">
                                                                        {% csrf_token %}
                                                                        <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Voulez-vous vraiment supprimer cet historique ?')">Supprimer</button>
                                                                    </form>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </li>
                                                {% endfor %}
                                            </ul>
                                        {% else %}
                                            <div class="alert alert-info text-center">
                                                Aucun historique enregistré pour cette hospitalisation.
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Button to Trigger Modal -->
                        {% if diagnostics %}
                            <button class="btn btn-outline-primary ml-2" data-toggle="modal"
                                    data-target="#diagnosticModal">
                                <em class="icon ni ni-list"></em> Diagnostics<span
                                    class="badge badge-info ml-1">{{ diagnosticscount }}</span>
                            </button>{% endif %}

                        <!-- Modal Diagnostics -->
                        <div class="modal fade" id="diagnosticModal" tabindex="-1"
                             aria-labelledby="diagnosticModalLabel" aria-hidden="true">
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="diagnosticModalLabel">Diagnostics Associés</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        {% if diagnostics %}
                                            <ul class="list-group">
                                                {% for diagnostic in diagnostics %}
                                                    <li class="list-group-item">
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <div>
                                                                <h6 class="mb-1">
                                                                    <strong>{{ diagnostic.date_diagnostic|naturaltime }}</strong>
                                                                    -
                                                                    <span class="badge bg-info text-dark">{{ diagnostic.get_type_diagnostic_display }}</span>
                                                                </h6>
                                                                <p class="mb-1">
                                                                    <strong>Maladie :</strong> {{ diagnostic.maladie }}
                                                                </p>
                                                                <p class="mb-1">
                                                                    <strong>Remarques
                                                                        :</strong> {{ diagnostic.remarques|safe|default:"Aucune remarque" }}
                                                                </p>
                                                                <p class="mb-1">
                                                                    <strong>Médecin
                                                                        :</strong> {{ diagnostic.medecin_responsable.get_full_name|default:"Inconnu" }}
                                                                </p>
                                                            </div>
                                                            <div>
                                                                {% if diagnostic.medecin_responsable == request.user %}
                                                                    <!-- Button to delete diagnostic -->
                                                                    <form method="post" action=""
                                                                          style="display:inline;">
                                                                        {% csrf_token %}
                                                                        <button type="submit"
                                                                                class="btn btn-danger btn-sm"
                                                                                onclick="return confirm('Voulez-vous vraiment supprimer ce diagnostic ?')">
                                                                            <em class="icon ni ni-trash"></em>
                                                                        </button>
                                                                    </form>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </li>
                                                {% endfor %}
                                            </ul>
                                        {% else %}
                                            <div class="alert alert-info text-center">
                                                Aucun diagnostic enregistré pour cette hospitalisation.
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% if avis_medicaux %}
                            <button class="btn btn-outline-primary ml-2" data-toggle="modal"
                                    data-target="#voiravisMedicalModal">
                                <em class="icon ni ni-edit-alt"></em> Avis medical<span
                                    class="badge badge-info ml-1">{{ avis_medicauxcount }}</span>
                            </button>
                        {% endif %}
                        <div class="modal fade" id="voiravisMedicalModal" tabindex="-1" aria-hidden="true">
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Avis Médicaux</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <input type="text" id="searchAvis" class="form-control mb-3"
                                               placeholder="Rechercher un avis médical">
                                        <div id="avisMedicalList">
                                            {% for avis in avis_medicaux %}
                                                <div class="card mb-3 avis-card">
                                                    <div class="card-header">
                                                        <strong>{{ avis.medecin.get_full_name }}</strong> -
                                                        <em>{{ avis.date_avis|date:"d/m/Y H:i" }}</em>
                                                    </div>
                                                    <div class="card-body">
                                                        <p>{{ avis.contenu|safe }}</p>
                                                        <small>Par : {{ avis.medecin.get_full_name }}</small>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <script>
                            document.addEventListener('DOMContentLoaded', function () {
                                const searchInput = document.getElementById('searchAvis');
                                const avisCards = document.querySelectorAll('.avis-card');

                                searchInput.addEventListener('input', function () {
                                    const searchValue = searchInput.value.toLowerCase();

                                    avisCards.forEach(card => {
                                        const title = card.querySelector('.card-header strong').innerText.toLowerCase();
                                        const content = card.querySelector('.card-body p').innerText.toLowerCase();

                                        if (title.includes(searchValue) || content.includes(searchValue)) {
                                            card.style.display = '';
                                        } else {
                                            card.style.display = 'none';
                                        }
                                    });
                                });
                            });
                        </script>
                        {% if effets_indesirables %}
                            <button class="btn btn-outline-primary ml-2" data-toggle="modal"
                                    data-target="#effetIndesirableModal">
                                <em class="icon ni ni-edit-alt"></em> Effets indesirables <span
                                    class="badge badge-info">{{ effets_indesirablescount }}</span>
                            </button>
                        {% endif %}

                        <div class="modal fade" id="effetIndesirableModal" tabindex="-1" aria-hidden="true">
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Effets Indésirables</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <input type="text" id="searchEffetsIndesirables" class="form-control mb-3"
                                               placeholder="Rechercher un effet indésirable">
                                        <div id="effetsIndesirablesList">
                                            {% for effet in effets_indesirables %}
                                                <div class="card mb-3 effet-card">
                                                    <div class="card-header">
                                                        <strong>Gravité : {{ effet.gravite }}</strong> -
                                                        <em>{{ effet.date_apparition|date:"d/m/Y" }}</em>
                                                    </div>
                                                    <div class="card-body">
                                                        <p><strong>Description : </strong>{{ effet.description }}</p>
                                                        <p><strong>Médicament associé
                                                            : </strong>{{ effet.medicament_associe.nom|default:"Non spécifié" }}
                                                        </p>
                                                        <small>Signalé par
                                                            : {{ effet.medecin.get_full_name|default:"Non spécifié" }}</small>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <script>
                            document.addEventListener('DOMContentLoaded', function () {
                                const searchInput = document.getElementById('searchEffetsIndesirables');
                                const effetCards = document.querySelectorAll('.effet-card');

                                searchInput.addEventListener('input', function () {
                                    const searchValue = searchInput.value.toLowerCase();

                                    effetCards.forEach(card => {
                                        const description = card.querySelector('.card-body').innerText.toLowerCase();

                                        if (description.includes(searchValue)) {
                                            card.style.display = '';
                                        } else {
                                            card.style.display = 'none';
                                        }
                                    });
                                });
                            });
                        </script>
                     {% if hopi_comment %}
                            <button class="btn btn-outline-primary ml-2" data-toggle="modal" data-target="#commentairesModal">
                                <em class="icon ni ni-edit-alt"></em>Comment.  <span class="badge badge-info">{{ hopi_commentcount }}</span>
                            </button>
                        {% endif %}

                       <div class="modal fade" id="commentairesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Commentaires des medecins </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Champ de recherche -->
                <input type="text" id="searchComment" class="form-control mb-3" placeholder="Rechercher un commentaire">

                <!-- Liste des commentaires -->
                <div id="commentList">
                    {% if hopi_comment %}
                        {% for comment in hopi_comment %}
                            <div class="card mb-3 comment-card">
                                <div class="card-header">
                                    <strong>{{ comment.medecin|default:"auteur inconnu" }}</strong> -
                                    <em>{{ comment.date_commentaire|naturaltime }}</em>
                                </div>
                                <div class="card-body">
                                    <p>{{ comment.contenu }}</p>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p>Aucun commentaire disponible.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const searchInput = document.getElementById('searchComment');
        const commentCards = document.querySelectorAll('.comment-card');

        searchInput.addEventListener('input', function () {
            const searchValue = searchInput.value.toLowerCase();

            commentCards.forEach(card => {
                const content = card.querySelector('.card-body').innerText.toLowerCase();

                if (content.includes(searchValue)) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
        });
    });
</script>



                        <!-- Modal Content Code -->
                        <div class="modal fade" tabindex="-1" id="hospitalisationout">
                            <div class="modal-dialog modal-lg" role="document">
                                <div class="modal-content ">
                                    <a href="#" class="close" data-dismiss="modal" aria-label="Close">
                                        <em class="icon ni ni-cross"></em>
                                    </a>
                                    <div class="modal-header">
                                        <h5 class="modal-title">Hospitalisation
                                            Patient: {{ hospitalisationdetail.patient }}</h5>
                                    </div>
                                    <div class="modal-body">
                                        <form method="POST"
                                              action="{% url 'update_hospitalisation_discharge' hospitalisation_id=hospitalisationdetail.id %}">
                                            {% csrf_token %}
                                            <div class="form-group">
                                                <label for="discharge_date">Date et heure de sortie</label>
                                                <input type="datetime-local" class="form-control" id="discharge_date"
                                                       name="discharge_date" required>
                                            </div>

                                            <div class="form-group">
                                                <label for="status">Mode de sortie</label>
                                                <select class="form-control" id="status" name="status" required>
                                                    <option value="Sortie">Sortie</option>
                                                    <option value="Gueris-EXEA">Gueris-EXEA</option>
                                                    <option value="Transféré-TRANSF">Transféré-TRANSF</option>
                                                    <option value="SCAM">SCAM</option>
                                                    <option value="EVADE">EVADE</option>
                                                    <option value="DCD">DCD</option>
                                                    <!-- Add other status options if needed -->
                                                </select>
                                            </div>
                                            <div class="form-group">
                                                <label for="discharge_reason">Commentaires</label>
                                                <textarea class="form-control" id="discharge_reason"
                                                          name="discharge_reason" rows="4" required></textarea>
                                            </div>
                                            <button type="submit" class="btn btn-primary">Sortir</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>


                </div>


                <div class="nk-block">
                <div class="card card-bordered card-stretch">
                        <div class="card-inner-group">
                            <div class="row">

                                <div class="col-lg-6">
                                   <div class="d-flex align-items-center"><!-- Texte à gauche -->
    <div class="text-start">
        <blockquote class="blockquote">
            <br class="mb-0">
                Admis le :</br>
                <strong class="text-primary">{{ hospitalisationdetail.created_at }}</strong>
            </p>
            <footer class="blockquote-footer">{{ hospitalisationdetail.reason_for_admission }}</footer>

            {% if hospitalisationdetail.discharge_date %}
                <p class="mb-0 mt-3">
                    Sortie le:</br>
                    <strong class="text-primary">{{ hospitalisationdetail.discharge_date }}</strong>
                </p>
                <footer class="blockquote-footer">
                <span class="badge badge-secondary">{{ hospitalisationdetail.status }}</span></br>
                    {{ hospitalisationdetail.discharge_reason }}
                </footer>
            {% endif %}
        </blockquote>

    </div>
    <!-- Image à droite -->
    <div class="me-3">
        {% if not hospitalisationdetail.discharge_date %}
            <img src="{% static 'images/hospitalization-2.gif' %}" height="200" alt="Hospitalization Image">
        {% endif %}

    </div>


</div>
                                </div>
                            {% if hospitalisationdetail.discharge_date  %}
                                {% else %}

                                <div class="col-lg-2 text-end">
                                <ul class="m-0 p-0 list-unstyled text-end">
                                        <li class="d-flex justify-content-between align-items-center">
                                            <button type="button" class="btn btn-outline-secondary uniform-btn mt-2" data-toggle="modal" data-target="#addobservationModal">
                                                <em class="icon ni ni-plus-circle-fill"></em>Observations
                                            </button>
                                            <div class="modal fade" id="addobservationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ajouter une Observations</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'add_observations' hospitalisation_id=hospitalisationdetail.id  %}">
                    {% csrf_token %}
                    {{ observationform.as_p }}
                    <button type="submit" class="btn btn-primary">Enregistrer</button>

                </form>
            </div>
        </div>
    </div>
</div>

                                            <script>
                                                document.addEventListener('DOMContentLoaded', function () {
                                                    // Reinitialiser TinyMCE quand le modal est affiché
                                                    $('#addobservationModal').on('shown.bs.modal', function () {
                                                        tinymce.remove(); // Supprimer les anciennes instances (si rechargé)
                                                        tinymce.init({
                                                            selector: '.tinymce-obs',
                                                            plugins: 'advlist autolink lists link charmap print preview anchor',
                                                            toolbar: 'bold italic underline | alignleft aligncenter alignright | bullist numlist outdent indent',
                                                            menubar: false,
                                                            height: 300,
                                                        });
                                                    });
                                                });
                                            </script>

                                            <!-- Bouton pour le modal de prescription -->
                                        </li>
                                        <li class="d-flex justify-content-between align-items-center">
                                            <button type="button" class="btn btn-outline-secondary uniform-btn  mt-2"
                                                    data-toggle="modal" data-target="#addhistoireModal">
                                                <em class="icon ni ni-plus-circle-fill"></em> Histoire
                                            </button>
                                             <div class="modal fade" id="addhistoireModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ajouter un Diagnostic</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'add_historique_maladie' hospitalisation_id=hospitalisationdetail.id  %}">
                    {% csrf_token %}
                    {{ historiquemaladieform.as_p }}
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </form>
            </div>
        </div>
    </div>
</div>

                                        </li>
                                    <li class="d-flex justify-content-between align-items-center">
        <button type="button" class="btn btn-outline-secondary  uniform-btn mt-2"
                data-toggle="modal" data-target="#addcommentModal">
            <em class="icon ni ni-plus-circle-fill"></em> Commentaire
        </button>
                    <div class="modal fade" id="addcommentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ajouter un commentaire</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'add_coment' hospitalisation_id=hospitalisationdetail.id  %}">
                    {% csrf_token %}
                    {{ hospicomment.as_p }}
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </form>
            </div>
        </div>
    </div>
</div>

    </li>


                                    </ul>
                                </div>
                                <div class="col-lg-3 text-end">

                                   <ul class="m-0 p-0 list-unstyled text-end">
    <li class="d-flex justify-content-between align-items-center">
        <button type="button" class="btn btn-outline-secondary  uniform-btn mt-2"
                data-toggle="modal" data-target="#adddiagnosticModal">
            <em class="icon ni ni-plus-circle-fill"></em> Diagnostic
        </button>

        <div class="modal fade" id="adddiagnosticModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ajouter un Diagnostic</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'add_diagnostic' hospitalisation_id=hospitalisationdetail.id  %}">
                    {% csrf_token %}
                    {{ diagnosticsform.as_p }}
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </form>
            </div>
        </div>
    </div>
</div>
    </li>
    <li class="d-flex justify-content-between align-items-center">
        <button type="button" class="btn btn-outline-secondary  uniform-btn mt-2"
                data-toggle="modal" data-target="#addavisModal">
            <em class="icon ni ni-plus-circle-fill"></em> Avis médical
        </button>

        <div class="modal fade" id="addavisModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ajouter un Avi medical</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'add_avis_medical' hospitalisation_id=hospitalisationdetail.id  %}">
                    {% csrf_token %}
                    {{ avismedicalform.as_p }}
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </form>
            </div>
        </div>
    </div>
</div>
         <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Reinitialiser TinyMCE quand le modal est affiché
            $('#addavisModal').on('shown.bs.modal', function () {
                tinymce.remove(); // Supprimer les anciennes instances (si rechargé)
                tinymce.init({
                    selector: '.tinymce-avis',
                    plugins: 'advlist autolink lists link charmap print preview anchor',
                    toolbar: 'bold italic underline | alignleft aligncenter alignright | bullist numlist outdent indent',
                    menubar: false,
                    height: 300,
                });
            });
        });
    </script>
    </li>

    <li class="d-flex justify-content-between align-items-center">
        <button type="button" class="btn btn-outline-secondary  uniform-btn mt-2"
                data-toggle="modal" data-target="#addeffetindesirableModal">
            <em class="icon ni ni-plus-circle-fill"></em> Effet indésirable
        </button>
        <div class="modal fade" id="addeffetindesirableModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ajouter un effet indesirable</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'add_effet_indesirable' hospitalisation_id=hospitalisationdetail.id  %}">
                    {% csrf_token %}
                    {{ effetindesirableform.as_p }}
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </form>
            </div>
        </div>
    </div>
</div>
        <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Reinitialiser TinyMCE quand le modal est affiché
            $('#addeffetindesirableModal').on('shown.bs.modal', function () {
                tinymce.remove(); // Supprimer les anciennes instances (si rechargé)
                tinymce.init({
                    selector: '.tinymce-effet',
                    plugins: 'advlist autolink lists link charmap print preview anchor',
                    toolbar: 'bold italic underline | alignleft aligncenter alignright | bullist numlist outdent indent',
                    menubar: false,
                    height: 300,
                });
            });
        });
    </script>
    </li>
</ul>

                                </div>
                             {% endif %}
                                

                            </div>
                            <div class="row">
                                <!-- Médicament manqué -->
                                <div class="col-lg-6 mx-auto">
                                    {% if missed_executions %}
                                        <div class="card shadow-sm border-0 bg-light rounded-lg p-4">
                                            <div class="card-body">
                                                <h5 class="text-danger font-weight-bold mb-3">
                                                    Médicaments Non Pris
                                                </h5>
                                                <ul class="list-group">
                                                    {% for execution in missed_executions %}
                                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                                            <div>
                                                                <strong>{{ execution.prescription.medication }}</strong>
                                                                <br>
                                                                <span class="text-muted">Heure prévue : {{ execution.scheduled_time|date:"d/m/Y H:i" }}</span>
                                                            </div>
                                                            <span class="badge badge-danger">Non pris</span>
                                                        </li>
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                        </div>
                                    {% else %}
                                        <div class="card shadow-sm border-0 bg-success text-white rounded-lg p-4">
                                            <div class="card-body text-center">
                                                <h5 class="font-weight-bold">Aucune Prise Manquée</h5>
                                                <p class="mt-2">Toutes les prescriptions ont été suivies à temps.</p>
                                            </div>
                                        </div>
                                    {% endif %}
                                </div>
                       
                                <div class="col-lg-6 mx-auto">
                                    {% if next_execution %}
                                        <div class="card shadow-sm border-0 bg-light rounded-lg p-4">
                                            <div class="card-body text-center">
                                                <h5 class="text-primary font-weight-bold">Prochaine Prise de
                                                    Médicament</h5>
                                                <h4 class="text-dark mt-3">{{ next_execution.prescription.medication }}</h4>
                                                <p class="text-muted">Date et heure prévue :
                                                    <strong>{{ next_execution.scheduled_time|date:"d/m/Y H:i"  }}</strong>
                                                </p>
                                                <div class="mt-4">
                                                    <div id="countdown"
                                                         class="display-4 text-warning font-weight-bold"></div>
                                                </div>
                                            </div>
                                        </div>
                                    {% else %}
                                        <div class="card shadow-sm border-0 bg-success text-white rounded-lg p-4">
                                            <div class="card-body text-center">
                                                <h5 class="font-weight-bold">Aucun Médicament Prévu</h5>
                                                <p class="mt-2">Tous les médicaments prescrits ont été administrés ou
                                                    aucune prescription n'est en attente.</p>
                                            </div>
                                        </div>
                                    {% endif %}
                                </div>
                                <script>
                                    {% if next_execution %}
                                        // Script pour le compte à rebours
                                        const nextExecutionTime = new Date("{{ next_execution.scheduled_time|date:"Y-m-d H:i:s" }}").getTime();
                                        const countdownElement = document.getElementById("countdown");

                                        const countdown = setInterval(function () {
                                            const now = new Date().getTime();
                                            const distance = nextExecutionTime - now;

                                            if (distance <= 0) {
                                                clearInterval(countdown);
                                                countdownElement.innerHTML = "Prise de médicament en cours ou en retard.";
                                            } else {
                                                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                                                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                                                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                                                countdownElement.innerHTML = `${hours}h ${minutes}m ${seconds}s`;
                                            }
                                        }, 1000);
                                    {% endif %}
                                </script>

                            </div>

                            <hr>
                      
                            <div class="row m-4">
                                <h3 class="text-muted"> Suivie de Soins </h3>

                                <div class="row col-12">


{#                                    <canvas id="constantesChart" width="400" height="200"></canvas>#}
                                     <div class="col-xl-12" id="constantesChart"></div>


                                </div>

                                <div class="row col-12">
                                    <!-- Constantes Card -->
                                    <!-- Tableau des constantes -->
                                    <div class="col-12 col-md-12 mb-5">
                                        <div class="card text-black-100 border">
                                            <div class="card-header">
                                                Constantes
                                                <a class="btn btn-outline-info btn-icon btn-round mr-5" href="#"><em
                                                        class="icon ni ni-download-cloud ml-10"></em></a>
                                                <button type="button"
                                                        class="btn btn-dark btn-icon btn-round float-right"
                                                        data-toggle="modal" data-target="#constanteModal">
                                                    <em class="icon ni ni-plus-circle-fill"></em>
                                                </button>
                                            </div>
                                            <div class="card-inner text-black-70">
                                                <table class="table">
                                                    <thead>
                                                    <tr>
                                                        <th>Constantes</th>
                                                        <th>Date</th>
                                                        <th>Medecin</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                    </thead>
                                                    <tbody>
                                                    {% if constantes %}
                                                        {% for constante in constantes %}
                                                            <tr class="{% if forloop.counter > 3 %}constante-data d-none{% endif %}">
                                                                <td>
                                <span class="badge badge-outline-dark">
                                    Tension: {{ constante.tension_systolique }} ts / {{ constante.tension_diastolique }} td - mmHg
                                </span><br>
                                                                    <span class="badge badge-outline-dark">Température | {{ constante.temperature }} °C</span>
                                                                </td>
                                                                <td>
                                                                    <span >{{ constante.created_at }}</span>
                                                                </td>

                                                                <td>
                                                                    <span >{{ constante.created_by }}</span>
                                                                </td>
                                                                <td>
                                <span>
                                    <a href="#" class="btn btn-primary btn-icon btn-round btn-xs"><em
                                            class="icon ni ni-eye"></em></a>
                                    <a class="btn btn-outline-info btn-icon btn-round btn-xs"
                                       href="{% url 'export_constante_pdf' hospitalisationdetail.id %}"><em
                                            class="icon ni ni-download-cloud ml-10"></em></a>
                                    <a href="#" class="btn btn-danger btn-icon btn-round btn-xs"><em
                                            class="icon ni ni-trash-fill"></em></a>
                                </span>
                                                                </td>
                                                            </tr>
                                                        {% endfor %}
                                                    {% else %}
                                                        <tr>
                                                            <td colspan="3"
                                                                style="font-style: italic; text-align: center"
                                                                class="text-white">
                                                                Aucune donnée enregistrée
                                                            </td>
                                                        </tr>
                                                    {% endif %}
                                                    </tbody>
                                                </table>
                                                <!-- Bouton pour afficher plus ou moins de données -->
                                                {% if constantes|length > 3 %}
                                                    <div class="text-center mt-3">
                                                        <button id="toggleButtonConstantes" class="btn btn-secondary">
                                                            Voir plus
                                                        </button>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>

                                    <!-- JavaScript pour le tableau des constantes -->
                                    <script>
                                        document.addEventListener('DOMContentLoaded', function () {
                                            const toggleButtonConstantes = document.getElementById('toggleButtonConstantes');
                                            const constanteDataRows = document.querySelectorAll('.constante-data');
                                            let isExpandedConstantes = false;

                                            toggleButtonConstantes.addEventListener('click', function () {
                                                if (isExpandedConstantes) {
                                                    constanteDataRows.forEach(row => row.classList.add('d-none'));
                                                    toggleButtonConstantes.textContent = 'Voir plus';
                                                } else {
                                                    constanteDataRows.forEach(row => row.classList.remove('d-none'));
                                                    toggleButtonConstantes.textContent = 'Voir moins';
                                                }
                                                isExpandedConstantes = !isExpandedConstantes;
                                            });
                                        });
                                    </script>

                                  <!-- Constante Form Modal -->
                                    <div class="modal fade" id="constanteModal" tabindex="-1"
                                         aria-labelledby="constanteModalLabel" aria-hidden="true">
                                        <div class="modal-dialog modal-lg">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="constanteModalLabel">Nouvelles
                                                        Constante</h5>
                                                    <button type="button" class="btn btn-close" data-bs-dismiss="modal"
                                                            aria-label="Close">X
                                                    </button>
                                                </div>
                                                <div class="modal-body">
                                                    <div class="row">
                                                        <form method="post"
                                                              action="{% url 'hospitalisationdetails' hospitalisationdetail.id %}">
                                                            {% csrf_token %}
                                                            <div class="row">
                                                                {% for field in constante_form %}
                                                                    <div class="col-md-6 mb-3">
                                                                        <div class="form-group">
                                                                            <label class="form-label"
                                                                                   for="{{ field.id_for_label }}">{{ field.label }}</label>
                                                                            <div class="form-control-wrap">
                                                                                {{ field }}
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                {% endfor %}
                                                            </div>
                                                            <button type="submit" class="btn btn-primary float-right">
                                                                Enregistrer
                                                            </button>
                                                        </form>
                                                    </div>

                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Executes prescriptions -->
                                    <div class="col-12 col-md-12 mb-5">
    <div class="card text-black-100 border">
        <div class="card-header d-flex justify-content-between">
            <h5 class="card-title">Suivi des soins prescrits</h5>
            <a class="btn btn-outline-info btn-icon btn-round" href="#">
                <em class="icon ni ni-download-cloud"></em>
            </a>
        </div>
        <div class="card-inner text-black-70">
            <table class="table table-bordered table-responsive-md">
                <thead>
                    <tr>
                        <th>Médicament</th>
                        <th>Heure Prévue</th>
                        <th>Heure Réelle</th>
                        <th>Durée</th>
                        <th>Status</th>
                        <th>Infirmier(ère)</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for execution in executions %}
                        <tr class="{% if forloop.counter > 5 %}prescription-suivi-data d-none{% endif %}">
                            <td>{{ execution.prescription.medication.nom }}</td>
                            <td>{{ execution.scheduled_time|naturaltime }}</td>
                            <td>
                                {% if execution.executed_at %}
                                    {{ execution.executed_at|naturaltime }}
                                {% else %}
                                    Non prise
                                {% endif %}
                            </td>
                            <td>{{ execution.prescription.pendant }}</td>
                            <td>
                                <span class="badge 
                                    {% if execution.status == 'Pending' %}badge-warning
                                    {% elif execution.status == 'Taken' %}badge-success
                                    {% else %}badge-danger{% endif %}">
                                    {{ execution.get_status_display }}
                                </span>
                            </td>
                            <td>
                                {% if execution.executed_by %}
                                    {{ execution.executed_by }}
                                {% else %}
                                    Non attribué
                                {% endif %}
                            </td>
                            <td>
                                {% if execution.status == 'Pending' %}
                                    <form method="post" action="{% url 'mark_execution_taken' %}">
                                        {% csrf_token %}
                                        <input type="hidden" name="execution_id" value="{{ execution.id }}">
                                        <button type="submit" class="btn btn-primary btn-sm">Marquer comme pris</button>
                                    </form>
                                {% else %}
                                    <button class="btn btn-secondary btn-sm" disabled>Déjà pris</button>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% if executions|length > 5 %}
                <div class="text-center mt-3">
                    <button id="toggleButtonPrescriptionssuivi" class="btn btn-secondary">
                        Voir plus
                    </button>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const toggleButton = document.getElementById('toggleButtonPrescriptionssuivi');
        const hiddenRows = document.querySelectorAll('.prescription-suivi-data');
        let isExpanded = false;

        toggleButton.addEventListener('click', function () {
            hiddenRows.forEach(row => row.classList.toggle('d-none'));
            isExpanded = !isExpanded;
            toggleButton.textContent = isExpanded ? 'Voir moins' : 'Voir plus';
        });
    });
</script>

                                    <!-- Prescription Card -->
                                    <!-- Tableau des prescriptions -->
                                    <div class="col-12 col-md-12 mb-5">
                                        <div class="card text-black-100 border">
                                            <div class="card-header">
                                                Prescriptions
                                                <a class="btn btn-outline-info btn-icon btn-round mr-5" href="#"><em class="icon ni ni-download-cloud ml-10"></em></a>
                                                <button type="button" class="btn btn-dark btn-icon btn-round float-right" data-toggle="modal" data-target="#prescriptionModal">
                                                    <em class="icon ni ni-plus-circle-fill"></em>
                                                </button>
                                            </div>
                                            <div class="card-inner text-black-70">
                                                <table class="table">
                                                    <thead>
                                                    <tr>

                                                        <th>Médicaments</th>
                                                        <th>Quantités</th>
                                                        <th>Posology</th>
                                                        <th>Date</th>
                                                        <th>Medecin</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                    </thead>
                                                    <tbody>

                                                    {% if prescriptions %}
                                                        {% for prescription in prescriptions %}
                                                            <tr class="{% if forloop.counter > 5 %}prescription-data d-none{% endif %}">
                                                                <td>
                                                                    {% if prescription.medication.dosage_form == 'Comprimé' %}
                                                                        <img src="{% static 'images/comprimes.png' %}"
                                                                             width="20">
                                                                    {% elif prescription.medication.dosage_form == 'Sirop' %}
                                                                        <img src="{% static 'images/sirop.png' %}"
                                                                             width="20">
                                                                    {% elif prescription.medication.dosage_form == 'Injection' %}
                                                                        <img src="{% static 'images/seringue.png' %}"
                                                                             width="20">
                                                                    {% elif prescription.medication.dosage_form == 'Gélule' %}
                                                                        <img src="{% static 'images/gelules.png' %}"
                                                                             width="20">
                                                                    {% elif prescription.medication.dosage_form == 'Crème' %}
                                                                        <img src="{% static 'images/pommade.png' %}"
                                                                             width="20">
                                                                    {% elif prescription.medication.dosage_form == 'Pommade' %}
                                                                        <img src="{% static 'images/pommade.png' %}"
                                                                             width="20">
                                                                    {% elif prescription.medication.dosage_form == 'Suppositoire' %}
                                                                        <img src="{% static 'images/suppositoire.png' %}"
                                                                             width="20">
                                                                    {% elif prescription.medication.dosage_form == 'Gouttes' %}
                                                                        <img src="{% static 'images/goutte-deau.png' %}"
                                                                             width="20">
                                                                    {% elif prescription.medication.dosage_form == 'Patch' %}
                                                                        <img src="{% static 'images/patch.png' %}"
                                                                             width="20">
                                                                    {% elif prescription.medication.dosage_form == 'Inhalateur' %}
                                                                        <img src="{% static 'images/spray-de-peinture.png' %}"
                                                                             width="20">
                                                                    {% elif prescription.medication.dosage_form == 'Solution' %}
                                                                        <img src="{% static 'images/solution.png' %}"
                                                                             width="20">
                                                                    {% elif prescription.medication.dosage_form == 'Suspension' %}
                                                                        <img src="{% static 'images/suspension.png' %}"
                                                                             width="20">
                                                                    {% elif prescription.medication.dosage_form == 'Poudre' %}
                                                                        <img src="{% static 'images/poudre-de-talc.png' %}"
                                                                             width="20">
                                                                    {% elif prescription.medication.dosage_form == 'Spray' %}
                                                                        <img src="{% static 'images/spray-de-peinture.png' %}"
                                                                             width="20">
                                                                    {% elif prescription.medication.dosage_form == 'Ovule' %}
                                                                        <img src="{% static 'images/ovule.png' %}"
                                                                             width="20">
                                                                    {% elif prescription.medication.dosage_form == 'Collyre' %}
                                                                        <img src="{% static 'images/collyre.png' %}"
                                                                             width="20">
                                                                    {% elif prescription.medication.dosage_form == 'Aérosol' %}
                                                                        <img src="{% static 'images/aerosol.png' %}"
                                                                             width="20">
                                                                    {% elif prescription.medication.dosage_form == 'Élixir' %}
                                                                        <img src="{% static 'images/elixir.png' %}"
                                                                             width="20">
                                                                    {% elif prescription.medication.dosage_form == 'Baume' %}
                                                                        <img src="{% static 'images/baume.png' %}"
                                                                             width="20">
                                                                    {% elif prescription.medication.dosage_form == 'Granulé' %}
                                                                        <img src="{% static 'images/granule.png' %}"
                                                                             width="20">
                                                                    {% elif prescription.medication.dosage_form == 'Capsule' %}
                                                                        <img src="{% static 'images/capsule.png' %}"
                                                                             width="20">
                                                                    {% endif %}
                                                                    <span class="badge badge-dark">{{ prescription.medication }}</span><br>
                                                                </td>
                                                                <td>
                                                                    <span class="badge badge-outline-secondary"> {{ prescription.quantity }} {{ prescription.medication.dosage_form }}(s)</span>
                                                                </td>
                                                                <td><span>{{ prescription.posology }}</span></td>
                                                                <td><span>{{ prescription.created_at }}</span></td>

                                                                <td>
                                                                    <span>{{ prescription.created_by }}</span>
                                                                </td>
                                                                <td> <form method="post" action="{% url 'delete_prescription' prescription.id %}" style="display:inline;">
        {% csrf_token %}
        <button type="submit" class="btn btn-danger btn-icon btn-round btn-xs" onclick="return confirm('Voulez-vous vraiment supprimer cette prescription ?')">
            <em class="icon ni ni-trash-fill"></em>
        </button>
    </form>
                                                                </td>
                                                            </tr>
                                                        {% endfor %}
                                                    {% else %}
                                                        <tr>
                                                            <td colspan="4" style="font-style: italic; text-align: center" class="text-white">
                                                                Aucune donnée enregistrée
                                                            </td>
                                                        </tr>
                                                    {% endif %}
                                                    </tbody>
                                                </table>
                                                <!-- Bouton pour afficher plus ou moins de données -->
                                                {% if prescriptions|length > 5 %}
                                                    <div class="text-center mt-3">
                                                        <button id="toggleButtonPrescriptions" class="btn btn-secondary">Voir plus
                                                        </button>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>


                                    <!-- JavaScript pour le tableau des prescriptions -->
                                    <script>
                                        document.addEventListener('DOMContentLoaded', function () {
                                            const toggleButtonPrescriptions = document.getElementById('toggleButtonPrescriptions');
                                            const prescriptionDataRows = document.querySelectorAll('.prescription-data');
                                            let isExpandedPrescriptions = false;

                                            toggleButtonPrescriptions.addEventListener('click', function () {
                                                if (isExpandedPrescriptions) {
                                                    prescriptionDataRows.forEach(row => row.classList.add('d-none'));
                                                    toggleButtonPrescriptions.textContent = 'Voir plus';
                                                } else {
                                                    prescriptionDataRows.forEach(row => row.classList.remove('d-none'));
                                                    toggleButtonPrescriptions.textContent = 'Voir moins';
                                                }
                                                isExpandedPrescriptions = !isExpandedPrescriptions;
                                            });
                                        });
                                    </script>

                                    <!-- Prescriptions Form Modal -->
                                    <div class="modal fade" id="prescriptionModal" tabindex="-1" aria-labelledby="prescriptionModalLabel" aria-hidden="true">
                                        <div class="modal-dialog modal-lg">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="prescriptionModalLabel">Nouvelles Prescription</h5>
                                                    <button type="button" class="btn btn-close" data-bs-dismiss="modal" aria-label="Close">X</button>
                                                </div>
                                                <div class="modal-body">
                                                    <div class="row">
                                                        <form method="post" action="{% url 'hospitalisationdetails' hospitalisationdetail.id %}">
                                                            {% csrf_token %}
                                                            <div class="row">
                                                                {% for field in prescription_hospi_form %}
                                                                    <div class="col-md-3 mb-3">
                                                                        <div class="form-group">
                                                                            <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
                                                                            <div class="form-control-wrap">
                                                                                {{ field }}
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                {% endfor %}
                                                            </div>
                                                            <button type="submit" class="btn btn-primary float-right">Enregistrer</button>
                                                        </form>
                                                    </div>

                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>
                                <!-- Indicateurs Biologiques -->
                                <div class="row m-4">

                                    <h3 class="text-muted"> Indicateurs Biologiques </h3>

                                    <div class="row col-12">
                                        <!-- Indicateur Biologique Card -->
                                        <div class="col-12 col-md-12 mb-5">
                                        <div id="biological-chart"></div>
                                        <div id="indicators-chart"></div>
                                            <div class="card text-black-100 border">
                                                <div class="card-header">
                                                    Indicateurs Biologiques
                                                    <button type="button" class="btn btn-dark btn-icon btn-round float-right" data-toggle="modal" data-target="#indicateurbiologiqueformModal">
                                                        <em class="icon ni ni-plus-circle-fill"></em>
                                                    </button>
                                                </div>
                                                <div class="card-inner text-black-70">
                                                    <table class="table">
                                                        <thead>
                                                        <tr>
                                                            <th>Indicateurs</th>
                                                            <th>Date</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                        </thead>
                                                        <tbody>
                                                        {% if indicateur_biologique %}
                                                            {% for indicateur in indicateur_biologique %}
                                                                <tr>
                                                                    <td>
                                                                        <span class="badge badge-dark">Globules Blancs: {{ indicateur.globules_blancs }}</span><br>
                                                                        <span class="badge badge-dark">Hémoglobine: {{ indicateur.hemoglobine }}</span>
                                                                    </td>
                                                                    <td>{{ indicateur.date|date:"d/m/Y" }}</td>
                                                                    <td>
                                    <span>
                                        <a href="#" class="btn btn-primary btn-icon btn-round btn-xs"><em
                                                class="icon ni ni-eye"></em></a>
                                        <a href="#" class="btn btn-danger btn-icon btn-round btn-xs"><em
                                                class="icon ni ni-trash-fill"></em></a>
                                    </span>
                                                                    </td>
                                                                </tr>
                                                            {% endfor %}
                                                        {% else %}
                                                            <tr>
                                                                <td colspan="3" style="font-style: italic; text-align: center" class="text-white">
                                                                    Aucune donnée enregistrée
                                                                </td>
                                                            </tr>
                                                        {% endif %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                     <!-- Indicateur Form Modal -->
                                    <div class="modal fade" id="indicateurbiologiqueformModal" tabindex="-1" aria-labelledby="indicateurbiologiqueformModalModalLabel" aria-hidden="true">
                                        <div class="modal-dialog modal-lg">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="indicateurbiologiqueformModalLabel">Indicateurs biologique</h5>
                                                    <button type="button" class="btn btn-close" data-bs-dismiss="modal" aria-label="Close">X</button>
                                                </div>
                                                <div class="modal-body">
                                                    <div class="row">
                                                        <form method="post" action="{% url 'hospitalisationdetails' hospitalisationdetail.id %}">
                                                            {% csrf_token %}
                                                            <div class="row">
                                                                {% for field in indicateur_biologique_form %}
                                                                    <div class="col-md-6 mb-3">
                                                                        <div class="form-group">
                                                                            <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
                                                                            <div class="form-control-wrap">
                                                                                {{ field }}
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                {% endfor %}
                                                            </div>
                                                            <button type="submit" class="btn btn-primary float-right">Enregistrer</button>
                                                        </form>
                                                    </div>

                                                </div>
                                            </div>
                                        </div>
                                    </div>


                                    </div>


                                </div>
                            <!-- Indicateurs  Fonctionnels  -->
                                <div class="row m-4">

                                    <h3 class="text-muted"> Indicateurs Fonctionnels </h3>

                                    <div class="row col-12">
                                        <!-- Signe Fonctionnel Card -->
                                        <!-- Indicateur Fonctionnel Card -->
                                    <div class="col-12 col-md-12 mb-5"><div id="functional-chart"></div></div>

                                        <div class="col-12 col-md-12 mb-5">
                                            <div class="card text-black-100 border">
                                                <div class="card-header">
                                                    Indicateurs Fonctionnels
                                                    <button type="button"
                                                            class="btn btn-dark btn-icon btn-round float-right"
                                                            data-toggle="modal"
                                                            data-target="#indicateurFonctionnelModal">
                                                        <em class="icon ni ni-plus-circle-fill"></em>
                                                    </button>
                                                </div>
                                                <div class="card-inner text-black-70">
                                                    <table class="table">
                                                        <thead>
                                                        <tr>
                                                            <th>Indicateurs</th>
                                                            <th>Date</th>
                                                            <th>Medecin</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                        </thead>
                                                        <tbody>
                                                        {% if indicateur_fonctionnel %}
                                                            {% for indicateur in indicateur_fonctionnel %}
                                                                <tr>
                                                                    <td>
                                                                        <span class="badge badge-dark">Mobilité: {{ indicateur.mobilite }}</span><br>
                                                                        <span class="badge badge-dark">Conscience: {{ indicateur.conscience }}</span><br>
                                                                        <span class="badge badge-dark">Débit urinaire: {{ indicateur.debit_urinaire }} L</span>
                                                                    </td>
                                                                    <td>{{ indicateur.date|date:"d/m/Y" }}</td>
                                                                     <td>{{ indicateur.patient}}</td>
                                                                    <td>
                                    <span>
                                        <a href="#" class="btn btn-primary btn-icon btn-round btn-xs"><em
                                                class="icon ni ni-eye"></em></a>
                                        <a href="#" class="btn btn-danger btn-icon btn-round btn-xs"><em
                                                class="icon ni ni-trash-fill"></em></a>
                                    </span>
                                                                    </td>
                                                                </tr>
                                                            {% endfor %}
                                                        {% else %}
                                                            <tr>
                                                                <td colspan="3"
                                                                    style="font-style: italic; text-align: center"
                                                                    class="text-white">
                                                                    Aucune donnée enregistrée
                                                                </td>
                                                            </tr>
                                                        {% endif %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                      <!-- Indicateur Fonctionnel Modal -->
                                    <div class="modal fade" id="indicateurFonctionnelModal" tabindex="-1"
                                         aria-labelledby="indicateurFonctionnelModalLabel" aria-hidden="true">
                                        <div class="modal-dialog modal-lg">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="indicateurFonctionnelModalLabel">Indicateurs Fonctionnels </h5>
                                                    <button type="button" class="btn btn-close" data-bs-dismiss="modal" aria-label="Close">X</button>
                                                </div>
                                                <div class="modal-body">
                                                    <div class="row">
                                                        <form method="post" action="{% url 'hospitalisationdetails' hospitalisationdetail.id %}">
                                                            {% csrf_token %}
                                                            <div class="row">
                                                                {% for field in indicateur_fonctionnel_form %}
                                                                    <div class="col-md-6 mb-3">
                                                                        <div class="form-group">
                                                                            <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
                                                                            <div class="form-control-wrap">
                                                                                {{ field }}
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                {% endfor %}
                                                            </div>
                                                            <button type="submit" class="btn btn-primary float-right">Enregistrer</button>
                                                        </form>
                                                    </div>

                                                </div>
                                            </div>
                                        </div>
                                    </div>




                                    </div>


                                </div>



                            <!-- Indicateurs  de Complications & de Traitement  -->

                            <div class="row m-4">

                                <h3 class="text-muted"> Indicateurs de Complications & de Traitement  </h3>


                                <div class="row col-12">
                                     <div class="col-12">
                                <div id="complications-chart"></div>
                            </div>
                                    <div class="col-3 col-md-3 mb-5">
                                        <div id="mental-state-chart"></div>
                                    </div>
                                    <div class="col-3 col-md-3 mb-5">
                                        <div id="electrolytes-balance-chart"></div>
                                    </div>

                                    <div class="col-3 col-md-3 mb-5">
                                        <div id="renal-function-chart"></div>
                                    </div>
                                    <div class="col-3 col-md-3 mb-5">
                                        <div id="hepatic-function-chart"></div>
                                    </div>
                                </div>
                                    <div class="col-12 col-md-12 mb-5">
                                        <div class="card text-black-100 border">
                                            <div class="card-header">
                                                Indicateurs Autres
                                                <button type="button"
                                                        class="btn btn-dark btn-icon btn-round float-right"
                                                        data-toggle="modal" data-target="#indicateurautresModal">
                                                    <em class="icon ni ni-plus-circle-fill"></em>
                                                </button>
                                            </div>
                                            <div class="card-inner text-black-70">
                                                <h2 class="mb-4">Liste des Indicateurs d'Hospitalisation</h2>
                                                <table class="table table-bordered table-responsive">
                                                    <thead>
                                                    <tr>
                                                        <th>Niveau de Douleur</th>
                                                        <th>État de Conscience</th>
                                                        <th>Réponse au Traitement</th>
                                                        <th>Effets Secondaires</th>
                                                        <th>Observance</th>
                                                        <th>Équilibre Électrolytique</th>
                                                        <th>Fonction Rénale</th>
                                                        <th>Fonction Hépatique</th>
                                                        <th>Signes Vitaux Stables</th>
                                                        <th>Douleur Contrôlée</th>
                                                        <th>Capacité Fonctionnelle</th>
                                                        <th>État Mental Stable</th>
                                                        <th>Plan de Suivi</th>
                                                        <th>Date de Création</th>
                                                    </tr>
                                                    </thead>
                                                    <tbody>
                                                    {% for indicator in indicators %}
                                                        <tr>
                                                            <td>{{ indicator.pain_level }}</td>
                                                            <td>{{ indicator.get_mental_state_display }}</td>
                                                            <td>{{ indicator.treatment_response }}</td>
                                                            <td>{{ indicator.side_effects }}</td>
                                                            <td>{{ indicator.compliance|yesno:"Oui,Non" }}</td>
                                                            <td>{{ indicator.electrolytes_balance }}</td>
                                                            <td>{{ indicator.renal_function }}</td>
                                                            <td>{{ indicator.hepatic_function }}</td>
                                                            <td>{{ indicator.stable_vitals|yesno:"Oui,Non" }}</td>
                                                            <td>{{ indicator.pain_controlled|yesno:"Oui,Non" }}</td>
                                                            <td>{{ indicator.functional_ability|yesno:"Oui,Non" }}</td>
                                                            <td>{{ indicator.mental_stability|yesno:"Oui,Non" }}</td>
                                                            <td>{{ indicator.follow_up_plan }}</td>
                                                            <td>{{ indicator.created_at|date:"d/m/Y H:i" }}</td>
                                                        </tr>
                                                    {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>


                            </div>

                        <div class="modal fade" id="indicateurautresModal" tabindex="-1" aria-labelledby="indicateurautresModalLabel" aria-hidden="true">
                                        <div class="modal-dialog modal-lg">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="indicateurautresModalLabel">Indicateurs autres</h5>
                                                    <button type="button" class="btn btn-close" data-bs-dismiss="modal" aria-label="Close">X</button>
                                                </div>
                                                <div class="modal-body">
                                                    <div class="row">
                                                        <form method="post" action="{% url 'hospitalisationdetails' hospitalisationdetail.id %}">
                                                            {% csrf_token %}
                                                            <div class="row">
                                                                {% for field in autresindicatorsform %}
                                                                    <div class="col-md-6 mb-3">
                                                                        <div class="form-group">
                                                                            <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
                                                                            <div class="form-control-wrap">{{ field }}</div>
                                                                        </div>
                                                                    </div>
                                                                {% endfor %}
                                                            </div>
                                                            <button type="submit" class="btn btn-primary float-right">Enregistrer</button>
                                                        </form>
                                                    </div>

                                                </div>
                                            </div>
                                        </div>
                                    </div><!-- Indicateurs  de Traitement  -->

                            <!-- Indicateurs  de Sortie  -->
                            <div class="row m-4">

                                <h3 class="text-muted"> Indicateurs de Sortie (Critères de décharge) </h3>

                                <div class="row col-12">
                                    <div class="col-12 col-md-12 mb-5">
                                        <div class="card text-black-100 border">
                                            <div class="card-header">
                                                Indicateurs de Sortie - Aide à la Décision
                                            </div>
                                            <div class="card-inner text-black-70">

                                                <div id="dischargeChart"></div>
                                            </div>
                                        </div>
                                    </div>


                                </div>


                            </div>
                        </div><!-- .card-inner-group -->
                    </div><!-- .card -->
                </div>
            </div>
        </div>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Reinitialiser TinyMCE quand le modal est affiché
            $('#adddiagnosticModal').on('shown.bs.modal', function () {
                tinymce.remove(); // Supprimer les anciennes instances (si rechargé)
                tinymce.init({
                    selector: '.tinymce-basic',
                    plugins: 'advlist autolink lists link charmap print preview anchor',
                    toolbar: 'bold italic underline | alignleft aligncenter alignright | bullist numlist outdent indent',
                    menubar: false,
                    height: 300,
                });
            });
        });
    </script>

    <script>
        // Données JSON pour les indicateurs et leurs plages
        const chartData = JSON.parse('{{ lab_ink|escapejs }}');

        // Extraire les valeurs pour la configuration des séries de données
        const categories = chartData.indicators.map(indicator => indicator.name);
        const seriesData = [
            {
                name: "Plage Normale",
                data: chartData.indicators.map(indicator => indicator.normal_part)
            },
            {
                name: "Valeur dans la Plage Normale",
                data: chartData.indicators.map(indicator => indicator.within_range)
            },
            {
                name: "Valeur Excédentaire/Déficitaire",
                data: chartData.indicators.map(indicator => indicator.additional_part)
            }
        ];

        // Configuration du graphique ApexCharts
        const options = {
            chart: {
                type: 'bar',
                height: 700,
                stacked: true,
            },
            series: seriesData,
            colors: ['#00E396', '#4CAF50', '#FF4560'], // Vert pour la plage normale, vert foncé pour la valeur dans la plage, rouge pour valeur hors norme
            plotOptions: {
                bar: {
                    horizontal: true,
                    barHeight: '80%',
                    dataLabels: {
                        position: 'top'
                    },
                }
            },
            dataLabels: {
                enabled: true,
                formatter: function (val, opts) {
                    const indicator = chartData.indicators[opts.dataPointIndex];
                    if (opts.seriesIndex === 2) {
                        return indicator.additional_part ? `Excès: ${indicator.additional_part}` : '';
                    } else if (opts.seriesIndex === 1) {
                        return indicator.actual !== null ? `Actuel: ${indicator.actual}` : 'N/A';
                    }
                    return '';
                },
                offsetX: -6,
                style: {
                    fontSize: '12px',
                    colors: ['#304758']
                }
            },
            xaxis: {
                categories: categories,
                title: {
                    text: 'Valeurs'
                }
            },
            title: {
                text: 'Indicateurs de Complications et Seuils de Danger',
                align: 'center'
            },
            tooltip: {
                shared: true,
                intersect: false,
                y: {
                    formatter: function (val, opts) {
                        const indicator = chartData.indicators[opts.dataPointIndex];
                        if (opts.seriesIndex === 2) {
                            return `Excédent ou déficit: ${indicator.additional_part}`;
                        }
                        return `Actuel: ${indicator.actual}`;
                    }
                }
            },
            legend: {
                position: 'top',
                horizontalAlign: 'left'
            }
        };

        // Rendu du graphique
        const chart = new ApexCharts(document.querySelector("#indicators-chart"), options);
        chart.render();
    </script>
    <script>
        // Données JSON pour le graphique des indicateurs fonctionnels
        const functionalData = JSON.parse('{{ functional_chart_data|escapejs }}');

        // Transformation des données qualitatives en valeurs numériques pour le graphique
        const mobilityValues = functionalData.mobilite.map(mobility => {
            if (mobility === "indépendant") return 3;
            if (mobility === "assisté") return 2;
            if (mobility === "immobile") return 1;
            return null;
        });

        const consciousnessValues = functionalData.conscience.map(consciousness => {
            if (consciousness === "alerte") return 3;
            if (consciousness === "somnolent") return 2;
            if (consciousness === "inconscient") return 1;
            return null;
        });

        // Configuration du graphique ApexCharts
        const functionalOptions = {
            chart: {
                type: 'bar',
                height: 450
            },
            series: [
                {
                    name: 'Mobilité',
                    data: mobilityValues
                },
                {
                    name: 'Conscience',
                    data: consciousnessValues
                },
                {
                    name: 'Débit Urinaire (L)',
                    data: functionalData.debit_urinaire
                }
            ],
            xaxis: {
                categories: functionalData.dates,
                title: {
                    text: 'Dates'
                },
                labels: {
                    rotate: -45
                }
            },
            yaxis: [
                {
                    title: {
                        text: 'Niveau Mobilité et Conscience'
                    },
                    min: 0,
                    max: 3,
                    tickAmount: 3,
                    labels: {
                        formatter: function (value) {
                            if (value === 3) return 'Indépendant / Alerte';
                            if (value === 2) return 'Assisté / Somnolent';
                            if (value === 1) return 'Immobile / Inconscient';
                            return '';
                        }
                    }
                },
                {
                    opposite: true,
                    title: {
                        text: 'Débit Urinaire (L)'
                    },
                    min: 0
                }
            ],
            tooltip: {
                shared: true,
                intersect: false,
            },
            title: {
                text: 'Évolution des Indicateurs Fonctionnels',
                align: 'center'
            }
        };

        // Rendu du graphique
        const functionalChart = new ApexCharts(document.querySelector("#functional-chart"), functionalOptions);
        functionalChart.render();
    </script>
    <script>
        // Données JSON pour les indicateurs de complications
        const complicationsData = JSON.parse('{{ complications_chart_data|escapejs }}');

        // Transformation de l'état mental en valeurs numériques
        const mentalStateValues = complicationsData.mental_state.map(state => {
            if (state === "clair") return 3;
            if (state === "confusion") return 2;
            if (state === "somnolent") return 1;
            return null;
        });

        // Configuration du graphique ApexCharts
        const complicationsOptions = {
            chart: {
                type: 'line',
                height: 450
            },
            series: [
                {
                    name: 'Niveau de Douleur',
                    data: complicationsData.pain_level
                },
                {
                    name: 'État Mental',
                    data: mentalStateValues
                }
            ],
            xaxis: {
                categories: complicationsData.dates,
                title: {
                    text: 'Dates'
                },
                labels: {
                    rotate: -45
                }
            },
            yaxis: [
                {
                    title: {
                        text: 'Niveau de Douleur'
                    },
                    min: 0,
                    max: 10,
                    tickAmount: 10
                },
                {
                    opposite: true,
                    title: {
                        text: 'État Mental'
                    },
                    min: 0,
                    max: 3,
                    tickAmount: 3,
                    labels: {
                        formatter: function (value) {
                            if (value === 3) return 'Clair';
                            if (value === 2) return 'Confusion';
                            if (value === 1) return 'Somnolent';
                            return '';
                        }
                    }
                }
            ],
            tooltip: {
                shared: true,
                intersect: false,
            },
            title: {
                text: 'Évolution des Indicateurs de Complications',
                align: 'center'
            }
        };

        // Rendu du graphique
        const complicationsChart = new ApexCharts(document.querySelector("#complications-chart"), complicationsOptions);
        complicationsChart.render();
    </script>
    <script>
        // Données JSON pour les graphiques en camembert
        const pieChartData = JSON.parse('{{ pie_chart_data|escapejs }}');

        // Fonction de configuration et de rendu d'un graphique en camembert
        function renderPieChart(elementId, seriesData, labels, title) {
            const options = {
                chart: {
                    type: 'donut',
                    height: 350
                },
                series: seriesData,
                labels: labels,
                title: {
                    text: title,
                    align: 'center'
                }
            };

            const chart = new ApexCharts(document.querySelector(elementId), options);
            chart.render();
        }

        // Données et rendu du graphique pour l'état mental
        const mentalStateLabels = Object.keys(pieChartData.mental_state);
        const mentalStateSeries = Object.values(pieChartData.mental_state);
        renderPieChart("#mental-state-chart", mentalStateSeries, mentalStateLabels, "État Mental");

        // Données et rendu du graphique pour l'équilibre électrolytique
        const electrolytesBalanceLabels = Object.keys(pieChartData.electrolytes_balance);
        const electrolytesBalanceSeries = Object.values(pieChartData.electrolytes_balance);
        renderPieChart("#electrolytes-balance-chart", electrolytesBalanceSeries, electrolytesBalanceLabels, "Équilibre Électrolytique");

        // Données et rendu du graphique pour la fonction rénale
        const renalFunctionLabels = Object.keys(pieChartData.renal_function);
        const renalFunctionSeries = Object.values(pieChartData.renal_function);
        renderPieChart("#renal-function-chart", renalFunctionSeries, renalFunctionLabels, "Fonction Rénale");

        // Données et rendu du graphique pour la fonction hépatique
        const hepaticFunctionLabels = Object.keys(pieChartData.hepatic_function);
        const hepaticFunctionSeries = Object.values(pieChartData.hepatic_function);
        renderPieChart("#hepatic-function-chart", hepaticFunctionSeries, hepaticFunctionLabels, "Fonction Hépatique");
    </script>
    <script>
        // Données JSON pour le graphique des indicateurs biologiques
        const biologicalData = JSON.parse('{{ chart_data|escapejs }}');

        // Configuration du graphique des indicateurs biologiques
        const biologicalOptions = {
            chart: {
                type: 'area',
                height: 450
            },
            series: [
                {
                    name: 'Globules blancs',
                    data: biologicalData.globules_blancs
                },
                {
                    name: 'Hémoglobine',
                    data: biologicalData.hemoglobine
                },
                {
                    name: 'Plaquettes',
                    data: biologicalData.plaquettes
                },
                {
                    name: 'CRP',
                    data: biologicalData.crp
                },
                {
                    name: 'Glucose sanguin',
                    data: biologicalData.glucose_sanguin
                }
            ],
            xaxis: {
                categories: biologicalData.dates,
                title: {
                    text: 'Dates'
                },
                labels: {
                    rotate: -45
                }
            },
            yaxis: {
                title: {
                    text: 'Valeurs'
                }
            },
            tooltip: {
                shared: true,
                intersect: false,
            },
            title: {
                text: 'Évolution des Indicateurs Biologiques',
                align: 'center'
            }
        };

        // Initialisation du graphique des indicateurs biologiques
        const biologicalChart = new ApexCharts(document.querySelector("#biological-chart"), biologicalOptions);
        biologicalChart.render();
    </script>
    <script>
        // Données JSON pour le graphique des constantes vitales
        const labels = [
            {% for constante in constantes %}
                "{{ constante.created_at|date:'Y-m-d H:i' }}",
            {% endfor %}
        ];

        const temperatureData = [
            {% for constante in constantes %}
                {{ constante.temperature|default:"null" }},
            {% endfor %}
        ];

        const heartRateData = [
            {% for constante in constantes %}
                {{ constante.frequence_cardiaque|default:"null" }},
            {% endfor %}
        ];

        const respiratoryRateData = [
            {% for constante in constantes %}
                {{ constante.frequence_respiratoire|default:"null" }},
            {% endfor %}
        ];

        const oxygenSaturationData = [
            {% for constante in constantes %}
                {{ constante.saturation_oxygene|default:"null" }},
            {% endfor %}
        ];

        // Configuration du graphique des constantes vitales
        const constantesOptions = {
            chart: {
                type: 'line',
                height: 350,
                zoom: {
                    enabled: true
                }
            },
            series: [
                {
                    name: 'Température (°C)',
                    data: temperatureData
                },
                {
                    name: 'Fréquence Cardiaque (bpm)',
                    data: heartRateData
                },
                {
                    name: 'Fréquence Respiratoire (rpm)',
                    data: respiratoryRateData
                },
                {
                    name: 'Saturation en Oxygène (%)',
                    data: oxygenSaturationData
                }
            ],
            xaxis: {
                categories: labels,
                title: {
                    text: 'Date et Heure'
                },
                type: 'datetime'
            },
            yaxis: {
                title: {
                    text: 'Valeurs des Constantes Vitales'
                },
                min: 0
            },
            title: {
                text: 'Évolution des Constantes Vitales du Patient',
                align: 'center'
            },
            tooltip: {
                x: {
                    format: 'dd MMM yyyy HH:mm'
                }
            }
        };

        // Initialisation du graphique des constantes vitales
        const constantesChart = new ApexCharts(document.querySelector("#constantesChart"), constantesOptions);
        constantesChart.render();
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            let formIdx = {{ symptomes_forms|length }};
            document.getElementById('add-symptome').addEventListener('click', function () {
                const newForm = document.createElement('div');
                newForm.className = 'row';
                const formHtml = `<div class="col-lg-6 col-sm-12 mb-3">
<div class="form-group">
<label class="form-label" for="id_symptomes-${formIdx}-nom">Nom</label>
<input type="text" name="nom[]" maxlength="255" class="form-control form-control-lg" required id="id_symptomes-${formIdx}-nom">
</div>
                              </div>
                              <div class="col-lg-6 col-sm-12 mb-3">
                                <div class="form-group">
                                    <label class="form-label" for="id_symptomes-${formIdx}-date_debut">Date début</label>
                                    <input type="date" name="date_debut[]" class="form-control form-control-lg" required id="id_symptomes-${formIdx}-date_debut">
                                </div>
                              </div>`;
                newForm.innerHTML = formHtml;
                document.getElementById('symptomes-forms').appendChild(newForm);
                formIdx++;
            });
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const dischargeCriteria = {{ discharge_criteria|safe }};

            const options = {
                chart: {
                    type: 'bar',
                    height: 350
                },
                plotOptions: {
                    bar: {
                        horizontal: true,
                        distributed: true,  // This makes each bar individually colorable
                        colors: {
                            ranges: [
                                {from: 1, to: 1, color: '#4CAF50'}, // Vert pour "Atteint"
                                {from: 0, to: 0, color: '#F44336'}  // Rouge pour "Non Atteint"
                            ]
                        }
                    }
                },
                dataLabels: {
                    enabled: true,
                    formatter: function (val) {
                        return val === 1 ? "Atteint" : "Non Atteint";
                    },
                    style: {
                        colors: ['#000']
                    }
                },
                series: [{
                    name: 'Critère de décharge',
                    data: [
                        dischargeCriteria.stable_vitals || 0,
                        dischargeCriteria.pain_controlled || 0,
                        dischargeCriteria.functional_ability || 0,
                        dischargeCriteria.mental_stability || 0,
                        dischargeCriteria.follow_up_plan || 0
                    ]
                }],
                xaxis: {
                    categories: [
                        "Signes vitaux stables",
                        "Douleur contrôlée",
                        "Capacité fonctionnelle",
                        "État mental stable",
                        "Plan de suivi post-hospitalisation"
                    ]
                },
                tooltip: {
                    enabled: true,
                    y: {
                        formatter: function (val) {
                            return val === 1 ? "Atteint" : "Non Atteint";
                        }
                    }
                }
            };

            const chart = new ApexCharts(document.querySelector("#dischargeChart"), options);
            chart.render();
        });
    </script>

    <script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function () {
        var booleanTypePairs = [
            { checkbox: 'prophylaxie_antiretrovirale', typeField: 'prophylaxie_type' },
            { checkbox: 'traitement_antiretrovirale', typeField: 'traitement_type' },
            { checkbox: 'dernier_regime_antiretrovirale', typeField: 'dernier_regime_antiretrovirale_type' },
            { checkbox: 'traitement_prophylactique_cotrimoxazole', typeField: 'traitement_prophylactique_cotrimoxazole_type' },
        ];

        function toggleTypeField(checkboxId, typeFieldId) {
            var checkbox = document.getElementById(checkboxId);
            var typeField = document.getElementById(typeFieldId);

            if (checkbox && typeField) {
                if (checkbox.checked) {
                    typeField.closest('.form-group').style.display = 'block';
                } else {
                    typeField.closest('.form-group').style.display = 'none';
                }
            }
        }

        booleanTypePairs.forEach(function(pair) {
            toggleTypeField(pair.checkbox, pair.typeField);

            document.getElementById(pair.checkbox).addEventListener('change', function() {
                toggleTypeField(pair.checkbox, pair.typeField);
            });
        });
    });
</script>
{% endblock %}