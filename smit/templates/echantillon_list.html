{% extends 'layout/base.html' %}
{% load static %}
{% load humanize %}

{% block content %}
    <div class="nk-content nk-content-fluid">
        <div class="container-xl wide-lg">
            <div class="nk-content-body">
                <!-- En-tête amélioré -->
                <div class="nk-block-head nk-block-head-sm">
                    <div class="nk-block-between g-3">
                        <div class="nk-block-head-content">
                            <h3 class="nk-block-title page-title">
                                <i class="fas fa-vial-circle-bolt text-primary"></i> Gestion des Prélèvements
                            </h3>
                            <div class="nk-block-des">
                                <p class="lead-text">
                                    <span class="badge badge-pill badge-light">{{ wpatient_nbr }}</span> prélèvements
                                    enregistrés
                                </p>
                            </div>
                        </div>

                        <div class="nk-block-head-content">
                            <div class="btn-group">
                                <a href="#" class="btn btn-primary" data-toggle="modal"
                                   data-target="#newEchantillonModal">
                                    <i class="fas fa-plus-circle mr-1"></i> Nouveau Prélèvement
                                </a>
                                <button type="button" class="btn btn-primary dropdown-toggle dropdown-toggle-split"
                                        data-toggle="dropdown">
                                    <span class="sr-only">Options</span>
                                </button>
                                <div class="dropdown-menu dropdown-menu-right">
                                    <a class="dropdown-item" href="#"><i class="fas fa-file-export mr-1"></i>
                                        Exporter</a>
                                    <a class="dropdown-item" href="#"><i class="fas fa-filter mr-1"></i> Filtres avancés</a>
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item" href="#"><i class="fas fa-cog mr-1"></i> Paramètres</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cartes de statistiques -->
                <div class="nk-block">
                    <div class="row g-gs">
    <div class="col-sm-6 col-lg-3">
        <div class="card card-bordered card-stats">
            <div class="card-inner">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <h6 class="overline-title">En attente</h6>
                        <h2 class="text-primary">{{ total_en_attente }}</h2>
                    </div>
                    <div class="icon bg-primary-dim">
                        <i class="fas fa-clock"></i>
                    </div>
                </div>
                <div class="progress progress-sm mt-3">
                    <div class="progress-bar bg-primary" style="width: {{ pourcent_en_attente }}%"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reprends la même logique pour les autres cartes -->
    <div class="col-sm-6 col-lg-3">
        <div class="card card-bordered card-stats">
            <div class="card-inner">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <h6 class="overline-title">Analysés</h6>
                        <h2 class="text-success">{{ total_analyse }}</h2>
                    </div>
                    <div class="icon bg-success-dim">
                        <i class="fas fa-check-circle"></i>
                    </div>
                </div>
                <div class="progress progress-sm mt-3">
                    <div class="progress-bar bg-success" style="width: {{ pourcent_analyse }}%"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Carte Rejetés -->
    <div class="col-sm-6 col-lg-3">
        <div class="card card-bordered card-stats">
            <div class="card-inner">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <h6 class="overline-title">Rejetés</h6>
                        <h2 class="text-danger">{{ total_rejete }}</h2>
                    </div>
                    <div class="icon bg-danger-dim">
                        <i class="fas fa-times-circle"></i>
                    </div>
                </div>
                <div class="progress progress-sm mt-3">
                    <div class="progress-bar bg-danger" style="width: {{ pourcent_rejete }}%"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Carte Stock -->
    <div class="col-sm-6 col-lg-3">
        <div class="card card-bordered card-stats">
            <div class="card-inner">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <h6 class="overline-title">Stock</h6>
                        <h2 class="text-info">{{ total_stock }}</h2>
                    </div>
                    <div class="icon bg-info-dim">
                        <i class="fas fa-boxes-stacked"></i>
                    </div>
                </div>
                <div class="progress progress-sm mt-3">
                    <div class="progress-bar bg-info" style="width: {{ pourcent_stock }}%"></div>
                </div>
            </div>
        </div>
    </div>
</div>
                </div>

                <!-- Tableau des prélèvements -->
                <div class="nk-block">
                    <div class="card card-bordered card-stretch">
                        <div class="card-inner-group">
                            <div class="card-inner p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover nk-tb-list">
                                        <thead>
                                        <tr class="nk-tb-item nk-tb-head">
{#                                            <th class="nk-tb-col ">#}
{#                                                <div class="custom-control custom-control-xs">#}
{#                                                    ##}
{#                                                </div>#}
{#                                            </th>#}
                                            <th class="nk-tb-col"><span>Code</span></th>
                                            <th class="nk-tb-col"><span>Patient</span></th>
                                            <th class="nk-tb-col"><span>Examen</span></th>
                                            <th class="nk-tb-col"><span>Date</span></th>
                                            <th class="nk-tb-col"><span>Resultat</span></th>
                                            <th class="nk-tb-col text-center"><span>Statut</span></th>
                                            <th class="nk-tb-col text-right"><span>Actions</span></th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        {% for preleve in echantillon.all %}
                                            <tr class="nk-tb-item">
{#                                                <td class="nk-tb-col">#}
{#                                                    <div class="custom-control custom-control-xs text-left">#}
{#                                                        {{ preleve.id }}#}
{#                                                    </div>#}
{#                                                </td>#}
                                                <td class="nk-tb-col">
                        <span class="badge badge-outline-primary">
                            <i class="fas fa-vial mr-1"></i> {{ preleve.code_echantillon|default:"N/A" }}
                        </span>
                                                </td>
                                                <td class="nk-tb-col">
                                                    <div class="user-card">
                                                        <div class="user-avatar bg-primary-dim">
                                                            <span>{{ preleve.patient.nom|first|upper }}{{ preleve.patient.prenoms|first|upper }}</span>
                                                        </div>
                                                        <div class="user-info">
                                                            <span class="tb-lead">{{ preleve.patient.nom }} {{ preleve.patient.prenoms }}</span>
                                                            <span class="text-muted">{{ preleve.patient.code_patient }}</span>
                                                        </div>
                                                    </div>
                                                </td>

                                                <td class="nk-tb-col">
                                                    <span>{{ preleve.examen_demande.nom|default:"N/A" }}</span>
                                                </td>

                                                <td class="nk-tb-col">
                                                    <span class="text-soft">{{ preleve.date_collect|date:"d/m/Y H:i"|default:"N/A" }}</span>
                                                </td>
 <td class="nk-tb-col">
                                                    result
                                                </td>
                                                <td class="nk-tb-col text-center">
                                                    {% if preleve.status_echantillons == "En attente" %}
                                                        <span class="badge badge-dim badge-warning">
                                <i class="fas fa-clock mr-1"></i> {{ preleve.status_echantillons }}
                            </span>
                                                    {% elif preleve.status_echantillons == "Analysé" %}
                                                        <span class="badge badge-dim badge-success">
                                <i class="fas fa-check-circle mr-1"></i> {{ preleve.status_echantillons }}
                            </span>
                                                    {% elif preleve.status_echantillons == "Rejeté" %}
                                                        <span class="badge badge-dim badge-danger">
                                <i class="fas fa-times-circle mr-1"></i> {{ preleve.status_echantillons }}
                            </span>
                                                    {% else %}
                                                        <span class="badge badge-dim badge-secondary">
                                <i class="fas fa-question-circle mr-1"></i> {{ preleve.status_echantillons|default:"Non défini" }}
                            </span>
                                                    {% endif %}
                                                </td>
                                                <td class="nk-tb-col text-right">

                                                    <div class="drodown ">
                                                        <button type="button" class="btn btn-xs btn-outline-primary mr-2"
                                                                data-toggle="modal"
                                                                data-target="#validatePrelevementModal{{ preleve.id }}">
                                                            <i class="fas fa-check-circle mr-1"></i> Valider
                                                        </button>
                                                        <!-- ✅ MODAL -->
                                                        <div class="modal fade"
                                                             id="validatePrelevementModal{{ preleve.id }}" tabindex="-1"
                                                             role="dialog"
                                                             aria-labelledby="validatePrelevementModalLabel"
                                                             aria-hidden="true">
                                                            <div class="modal-dialog modal-dialog-centered"
                                                                 role="document">
                                                                <div class="modal-content">

                                                                    <div class="modal-header">
                                                                        <h5 class="" id="">
                                                                            Confirmation prélèvement
                                                                            <strong>{{ preleve.patient }} {{ preleve.id }}</strong>
                                                                            ?
                                                                        </h5>
                                                                        <button type="button" class="close"
                                                                                data-dismiss="modal"
                                                                                aria-label="Fermer">
                                                                            <span aria-hidden="true">&times;</span>
                                                                        </button>
                                                                    </div>

                                                                    <div class="modal-body">
                                                                        <form method="POST"
                                                                              action="{% url 'validate_serologie_vih_request' preleve_id=preleve.id %}">
                                                                            {% csrf_token %}
                                                                            <button type="button"
                                                                                    class="btn btn-secondary"
                                                                                    data-dismiss="modal">Annuler
                                                                            </button>
                                                                            <button type="submit"
                                                                                    class="btn btn-success">
                                                                                <i class="fas fa-check mr-1"></i>
                                                                                Confirmer
                                                                            </button>
                                                                        </form>
                                                                    </div>

                                                                    <div class="modal-footer">

                                                                    </div>

                                                                </div>
                                                            </div>
                                                        </div>
                                                        <a href="#" class="btn btn-trigger btn-icon dropdown-toggle"
                                                           data-toggle="dropdown">
                                                            <i class="fas fa-ellipsis-v"></i>
                                                        </a>
                                                        <div class="dropdown-menu dropdown-menu-right"
                                                             style="z-index: 1">
                                                            <ul class="link-list-opt no-bdr">
                                                                <li>
                                                                    <a href="#" data-toggle="modal"
                                                                       data-target="#detailsEchantillon{{ preleve.id }}">
                                                                        <i class="fas fa-eye mr-1"></i> Détails
                                                                    </a>
                                                                </li>
                                                                <li>
                                                                    <a href="#"><i class="fas fa-edit mr-1"></i>
                                                                        Modifier</a>
                                                                </li>
                                                                <li>
                                                                    <a href="{% url 'echantillon_detail' preleve.pk %}"><i class="fas fa-flask mr-1"></i>
                                                                        Analyser</a>
                                                                </li>
                                                                <li class="divider"></li>
                                                                <li>
                                                                    <a href="#" class="text-danger"><i
                                                                            class="fas fa-trash-alt mr-1"></i> Supprimer</a>
                                                                </li>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Modals (identique à la version originale) -->
                            {% for preleve in echantillon.all %}
                                <div class="modal fade" id="detailsEchantillon{{ preleve.id }}" tabindex="-1"
                                     role="dialog">
                                    <div class="modal-dialog modal-lg" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">
                                                    <i class="fas fa-vial mr-2"></i> Détails du prélèvement
                                                    #{{ preleve.code_echantillon }}
                                                </h5>
                                                <button type="button" class="close" data-dismiss="modal"
                                                        aria-label="Close">
                                                    <span aria-hidden="true">&times;</span>
                                                </button>
                                            </div>
                                            <div class="modal-body">
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <div class="card card-bordered">
                                                            <div class="card-header bg-light">
                                                                <h6 class="card-title"><i
                                                                        class="fas fa-user-injured mr-2"></i> Patient
                                                                </h6>
                                                            </div>
                                                            <div class="card-body">
                                                                <div class="d-flex align-items-center">
                                                                    <div class="user-avatar bg-primary-dim mr-3">
                                                                        <span>{{ preleve.patient.nom|first|upper }}{{ preleve.patient.prenoms|first|upper }}</span>
                                                                    </div>
                                                                    <div>
                                                                        <h5>{{ preleve.patient.nom }} {{ preleve.patient.prenoms }}</h5>
                                                                        <p class="text-muted mb-1">
                                                                            Code: {{ preleve.patient.code_patient }}</p>
                                                                        <p class="text-muted">
                                                                            Âge: {{ preleve.patient.calculate_age }} ans</p>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <div class="card card-bordered mt-3">
                                                            <div class="card-header bg-light">
                                                                <h6 class="card-title"><i
                                                                        class="fas fa-calendar-check mr-2"></i> Collecte
                                                                </h6>
                                                            </div>
                                                            <div class="card-body">
                                                                <ul class="list-group list-group-flush">
                                                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                                                        <span>Date</span>
                                                                        <span class="font-weight-bold">{{ preleve.created_at|date:"d/m/Y H:i" }}</span>
                                                                    </li>
                                                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                                                        <span>Site</span>
                                                                        <span class="font-weight-bold">{{ preleve.site_collect|default:"SMIT-Prelevement" }}</span>
                                                                    </li>
                                                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                                                        <span>Agent</span>
                                                                        <span class="font-weight-bold">{{ preleve.agent_collect|default:"N/A" }}</span>
                                                                    </li>
                                                                </ul>
                                                            </div>
                                                        </div>

                                                        <div class="card card-bordered mt-3">
                                                            <div class="card-header bg-light">
                                                                <h6 class="card-title"><i
                                                                        class="fas fa-microscope mr-2"></i> Résultats
                                                                </h6>
                                                            </div>
                                                            <div class="card-body">
                                                                <ul class="list-group list-group-flush">
                                                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                                                        <span>Valeur</span>
                                                                        <span class="font-weight-bold">{{ preleve.resultat|default:"N/A" }}</span>
                                                                    </li>
                                                                </ul>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="col-md-6">
                                                        <div class="card card-bordered">
                                                            <div class="card-header bg-light">
                                                                <h6 class="card-title"><i class="fas fa-flask mr-2"></i>
                                                                    Spécimen</h6>
                                                            </div>
                                                            <div class="card-body">
                                                                <ul class="list-group list-group-flush">
                                                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                                                        <span>Type</span>
                                                                        <span class="badge badge-{{ preleve.type.nom|lower }}">{{ preleve.type }}</span>
                                                                    </li>
                                                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                                                        <span>Examen demandé</span>
                                                                        <span class="font-weight-bold">{{ preleve.examen_demande.nom|default:"N/A" }}</span>
                                                                    </li>
                                                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                                                        <span>Volume</span>
                                                                        <span class="font-weight-bold">{{ preleve.volume|default:"N/A" }} ml</span>
                                                                    </li>
                                                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                                                        <span>Statut</span>
                                                                        {% if preleve.status_echantillons == "En attente" %}
                                                                            <span class="badge badge-warning">{{ preleve.status_echantillons }}</span>
                                                                        {% elif preleve.status_echantillons == "Analysé" %}
                                                                            <span class="badge badge-success">{{ preleve.status_echantillons }}</span>
                                                                        {% elif preleve.status_echantillons == "Rejeté" %}
                                                                            <span class="badge badge-danger">{{ preleve.status_echantillons }}</span>
                                                                        {% else %}
                                                                            <span class="badge badge-secondary">{{ preleve.status_echantillons|default:"Non défini" }}</span>
                                                                        {% endif %}
                                                                    </li>
                                                                </ul>
                                                            </div>
                                                        </div>

                                                        <div class="card card-bordered mt-3">
                                                            <div class="card-header bg-light">
                                                                <h6 class="card-title"><i
                                                                        class="fas fa-box-archive mr-2"></i> Stockage
                                                                </h6>
                                                            </div>
                                                            <div class="card-body">
                                                                <ul class="list-group list-group-flush">
                                                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                                                        <span>Emplacement</span>
                                                                        <span class="font-weight-bold">{{ preleve.storage_location|default:"N/A" }}</span>
                                                                    </li>
                                                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                                                        <span>Température</span>
                                                                        <span class="font-weight-bold">{{ preleve.storage_temperature|default:"N/A" }}</span>
                                                                    </li>
                                                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                                                        <span>Date expiration</span>
                                                                        <span class="font-weight-bold">{{ preleve.expiration_date|default:"N/A" }}</span>
                                                                    </li>
                                                                </ul>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                                                    Fermer
                                                </button>
                                                <button type="button" class="btn btn-primary">
                                                    <i class="fas fa-print mr-1"></i> Imprimer
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}

                            <!-- Pagination -->
                            <div class="card-inner">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="text-soft">
                                        Affichage de {{ page_obj.start_index }} à {{ page_obj.end_index }}
                                        sur {{ page_obj.paginator.count }} prélèvements
                                    </div>
                                    <ul class="pagination">
                                        {% if page_obj.has_previous %}
                                            <li class="page-item">
                                                <a class="page-link" href="?page={{ page_obj.previous_page_number }}">
                                                    <i class="fas fa-chevron-left"></i>
                                                </a>
                                            </li>
                                        {% else %}
                                            <li class="page-item disabled">
                                                <span class="page-link"><i class="fas fa-chevron-left"></i></span>
                                            </li>
                                        {% endif %}

                                        {% for num in page_obj.paginator.page_range %}
                                            {% if page_obj.number == num %}
                                                <li class="page-item active">
                                                    <span class="page-link">{{ num }}</span>
                                                </li>
                                            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                                <li class="page-item">
                                                    <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                                                </li>
                                            {% endif %}
                                        {% endfor %}

                                        {% if page_obj.has_next %}
                                            <li class="page-item">
                                                <a class="page-link" href="?page={{ page_obj.next_page_number }}">
                                                    <i class="fas fa-chevron-right"></i>
                                                </a>
                                            </li>
                                        {% else %}
                                            <li class="page-item disabled">
                                                <span class="page-link"><i class="fas fa-chevron-right"></i></span>
                                            </li>
                                        {% endif %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Nouveau Prélèvement -->
    <div class="modal fade" id="newEchantillonModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-vial-circle-bolt mr-2"></i> Nouveau Prélèvement
                    </h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form method="post" action="# url 'add_echantillon' %}">
                    {% csrf_token %}
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Patient*</label>
                                    <select class="form-control select2" name="patient" required>
                                        <option value="">Sélectionner un patient</option>
                                        {% for patient in patients %}
                                            <option value="{{ patient.id }}">{{ patient.nom }} {{ patient.prenom }}
                                                ({{ patient.code_patient }})
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Type d'échantillon*</label>
                                    <select class="form-control" name="type_echantillon" required>
                                        <option value="">Sélectionner un type</option>
                                        {% for type in types_echantillon %}
                                            <option value="{{ type.id }}">{{ type.nom }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Examen demandé*</label>
                                    <select class="form-control select2" name="examen_demande" required>
                                        <option value="">Sélectionner un examen</option>
                                        {% for examen in examens %}
                                            <option value="{{ examen.id }}">{{ examen.nom }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Volume (ml)</label>
                                    <input type="number" step="0.1" class="form-control" name="volume"
                                           placeholder="Ex: 5.0">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Date de collecte</label>
                                    <input type="datetime-local" class="form-control" name="date_collect">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Site de collecte</label>
                                    <input type="text" class="form-control" name="site_collect"
                                           placeholder="Ex: Bras gauche">
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Notes supplémentaires</label>
                            <textarea class="form-control" name="notes" rows="3"
                                      placeholder="Informations complémentaires..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save mr-1"></i> Enregistrer
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock %}

{% block css %}
    <style>
        .badge-blood {
            background-color: #ffebee;
            color: #c62828;
            border: 1px solid #ef9a9a;
        }

        .badge-urine {
            background-color: #e3f2fd;
            color: #1565c0;
            border: 1px solid #90caf9;
        }

        .badge-tissue {
            background-color: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #a5d6a7;
        }

        .card-stats {
            border-left: 4px solid;
            transition: all 0.3s ease;
        }

        .card-stats:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #fff;
        }

        .bg-primary-dim {
            background-color: rgba(70, 128, 255, 0.1);
            color: #4680ff;
        }

        .bg-success-dim {
            background-color: rgba(58, 191, 132, 0.1);
            color: #3abf84;
        }

        .bg-danger-dim {
            background-color: rgba(255, 71, 87, 0.1);
            color: #ff4757;
        }

        .bg-info-dim {
            background-color: rgba(12, 208, 223, 0.1);
            color: #0cd0df;
        }

        .lead-text {
            font-size: 1.1rem;
            color: #526484;
        }
    </style>
{% endblock %}

{% block js %}
    <script>
        $(document).ready(function () {
            // Initialisation des select2
            $('.select2').select2({
                width: '100%',
                placeholder: 'Sélectionner une option'
            });

            // Gestion des modals
            $('.modal').on('shown.bs.modal', function () {
                $(this).find('.select2').select2({
                    width: '100%',
                    dropdownParent: $(this)
                });
            });

            // Confirmation avant suppression
            $('.btn-delete').click(function (e) {
                e.preventDefault();
                if (confirm('Voulez-vous vraiment supprimer ce prélèvement ?')) {
                    window.location = $(this).attr('href');
                }
            });
        });
    </script>
{% endblock %}